
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Fishualizer &#8212; Fishualizer 3 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Fishualizer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="k">import</span> <span class="n">RotatingFileHandler</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="k">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">Qt</span>
<span class="c1"># from pyqtgraph.Qt import QtCore, QtGui</span>
<span class="kn">import</span> <span class="nn">pyqtgraph.opengl</span> <span class="k">as</span> <span class="nn">gl</span>
<span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">from</span> <span class="nn">pyqtgraph.dockarea</span> <span class="k">import</span> <span class="n">DockArea</span><span class="p">,</span> <span class="n">Dock</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c1"># matplotlib.use(&#39;Qt5Agg&#39;)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">Controls</span> <span class="k">import</span> <span class="n">ColorRangePicker</span><span class="p">,</span> <span class="n">ShortcutsDialog</span><span class="p">,</span> <span class="n">StaticDataDialog</span><span class="p">,</span> <span class="n">SelectCellDialog</span><span class="p">,</span> <span class="n">GLViewWidgetPos</span><span class="p">,</span> \
    <span class="n">LogWindow</span><span class="p">,</span> <span class="n">CorrelationDialog</span><span class="p">,</span> <span class="n">ClusterDialog</span><span class="p">,</span> <span class="n">OpenDataDialog</span><span class="p">,</span> <span class="n">ExtendedComboBox</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="k">import</span> <span class="n">kmeans</span><span class="p">,</span> <span class="n">vq</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">Delaunay</span><span class="p">,</span> <span class="n">ConvexHull</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">internal_ipkernel</span> <span class="k">import</span> <span class="n">InternalIPKernel</span>
<span class="kn">from</span> <span class="nn">imageio</span> <span class="k">import</span> <span class="n">get_writer</span><span class="p">,</span> <span class="n">imwrite</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">utilities</span>
<span class="kn">import</span> <span class="nn">alpha_shape</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="k">import</span> <span class="n">load_config</span><span class="p">,</span> <span class="n">Zecording</span>
<span class="kn">from</span> <span class="nn">Analysis</span> <span class="k">import</span> <span class="n">correlation_1D2D</span>
<span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;OASIS-master&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>  <span class="c1"># load Friedrich et alii deconvolution package</span>
    <span class="sd">&quot;&quot;&quot; For OASIS packages download &amp; demo, see</span>
<span class="sd">    https://github.com/j-friedrich/OASIS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">oasis</span> <span class="k">import</span> <span class="n">oasisAR1</span>
    <span class="kn">import</span> <span class="nn">oasis.functions</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">curr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">subprocess</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;OASIS-master/&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Installing OASIS&#39;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;setup.py&#39;</span><span class="p">,</span> <span class="s1">&#39;build_ext&#39;</span><span class="p">,</span> <span class="s1">&#39;--inplace&#39;</span><span class="p">])</span>  <span class="c1"># try to install automatically</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Installation done&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OASIS could not be installed automatically, </span><span class="se">\n</span><span class="s2"> if you would like to&quot;</span>
              <span class="s2">&quot;use online deconvolution, please see their github page github.com/j-friedrich/OASIS&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">oasis</span> <span class="k">import</span> <span class="n">oasisAR1</span>
        <span class="kn">import</span> <span class="nn">oasis.functions</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OASIS module not loaded, spikes will not be deconvolved online. </span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="s2">&quot;Make sure OASIS is installed correctly &quot;</span>
              <span class="s2">&quot;(see their brief Github installation guide: github.com/j-friedrich/OASIS )&quot;</span><span class="p">)</span>

<span class="c1"># TODO: logarithmic color scale</span>
<span class="c1"># TODO: Show numeric values along color scale bar when plotting static analysis data (it is linear)</span>
<span class="c1"># TODO: define Ctrl-Mouse Drag to drag the view for trackpads?</span>
<span class="c1"># TODO: color code by motor/sensory/functional/top level areas? [i.e. color = area, brightness = activity]</span>
<span class="c1"># TODO: Add &#39;reset view&#39; shortcut (reset zoom, pan, selection, colors, transparency)</span>

<span class="c1"># NOTES on Color:</span>
<span class="c1"># start_color, stop_color : define the points where the variable color-range starts and stops</span>
<span class="c1"># disp_start, disp_stop : define the data values, which are mapped to this color range</span>
<span class="c1"># when clicking on the colorbar, only start_color and stop_color are changed</span>
<span class="c1"># when the edits are changed, then disp_start and disp_stop are changed</span>


<span class="c1"># noinspection PyUnresolvedReferences</span>
<div class="viewcode-block" id="Viewer"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer">[docs]</a><span class="k">class</span> <span class="nc">Viewer</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class that is not directly used. Its code is defining the basic elements of the GUI</span>
<span class="sd">    without having any real logic behind it. It could be automatically created from a GUI creation tool like QTDesigner.</span>
<span class="sd">    The idea is to separate form (the GUI elements) and function (what do they do)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create and initialize window</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Viewer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>  <span class="c1"># Calling the parent class __init__ method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_DeleteOnClose</span><span class="p">)</span>

        <span class="c1"># Menu bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;&amp;File&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;&amp;Edit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;&amp;View&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;&amp;Compute&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;E&amp;xtra&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">help_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;&amp;Help&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Open data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_data_file</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_O</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Add static data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_static_gui</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_A</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Quit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_Q</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Select neuron by id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_select_cell_dialog</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_G</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Hide points below threshold&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit_hide</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Hide points above threshold&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit_hide</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_view_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;View all neurons&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_min</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_max</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_view_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Inverse x axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_x_axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Inverse y axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_y_axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Inverse z axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_z_axis</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Color map&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edit_cmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;Transparency mode&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">add_callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">,</span> <span class="s1">&#39;additive&#39;</span><span class="p">)</span>
        <span class="n">trans_callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">,</span> <span class="s1">&#39;translucent&#39;</span><span class="p">)</span>
        <span class="n">op_callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">,</span> <span class="s1">&#39;opaque&#39;</span><span class="p">)</span>
        <span class="n">alpha_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QActionGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Additive&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">add_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_action</span> <span class="o">=</span> <span class="n">alpha_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Translucent&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">trans_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_action</span> <span class="o">=</span> <span class="n">alpha_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Opaque&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">op_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_action</span> <span class="o">=</span> <span class="n">alpha_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_cluster_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Color &amp;clusters&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_cluster_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;Change Perspective&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">perspective_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QActionGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">perspective_2d_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;2D Perspective&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">perspective_2d_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_perspective_2d</span><span class="p">)</span>
        <span class="n">perspective_2d_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">perspective_2d_action</span> <span class="o">=</span> <span class="n">perspective_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">perspective_2d_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">perspective_2d_action</span><span class="p">)</span>
        <span class="n">perspective_3d_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;3D Perspective&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">perspective_3d_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_perspective_3d</span><span class="p">)</span>
        <span class="n">perspective_3d_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">perspective_3d_action</span> <span class="o">=</span> <span class="n">perspective_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">perspective_3d_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perspective_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">perspective_3d_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perspective_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Change Playing Speed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_playtimer_interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Pan left&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pan_left</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_J</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Pan right&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pan_right</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Pan front&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pan_front</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_I</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Pan back&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pan_back</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_M</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Center view&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_view</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Toggle current/previous dataset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_toggle</span><span class="p">,</span>
                                 <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_T</span><span class="p">)</span>
        <span class="n">rot_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Toggle rotation during animation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rot_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_R</span><span class="p">)</span>
        <span class="n">rot_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_rotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">rot_action</span><span class="p">)</span>
        <span class="n">fit_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Toggle calcium fit plot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fit_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_Y</span><span class="p">)</span>
        <span class="n">fit_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_calcium_fit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">fit_action</span><span class="p">)</span>
        <span class="n">neuropil_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Toggle neuropil plot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">neuropil_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_N</span><span class="p">)</span>
        <span class="n">neuropil_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_hideneuropil</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">neuropil_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_region_view_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Toggle region view (local/ZBrainAtlas)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_region_view</span><span class="p">)</span>
        <span class="c1"># self.change_region_view_action.setEnabled(False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="n">limit_group</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QActionGroup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;Limit axis extent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;X-axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limitx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span> <span class="o">=</span> <span class="n">limit_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Y-axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_action</span> <span class="o">=</span> <span class="n">limit_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Z-axis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limitz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_action</span> <span class="o">=</span> <span class="n">limit_group</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;View y-z projection&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewyz</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;View x-z projection&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewxz</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;View x-y projection&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewxy</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Reverse z coordinates&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_reverse_z_coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_menu</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;Draw 2D Outline&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_outline_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;XY Outline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_outline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draw_xy_outline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_outline_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_outline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yz_outline_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;YZ Outline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yz_outline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draw_yz_outline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yz_outline_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yz_outline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xz_outline_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;XZ Outline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xz_outline_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draw_xz_outline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xz_outline_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xz_outline_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_action</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAction</span><span class="p">(</span><span class="s1">&#39;Start/Stop video export&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">checkable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_action</span><span class="o">.</span><span class="n">setShortcut</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_V</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_export</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;Take a screenshot&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab_plot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Correlation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_gui</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">help_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Shortcuts&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_shortcuts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extra_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Log&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_log</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="s1">&#39;&amp;Console&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CTRL</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ALT</span> <span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Key_C</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edit_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">addMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help_menu</span><span class="p">)</span>

        <span class="c1"># MAIN LAYOUT</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">800</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_main</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="c1"># create a main widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_layout_main</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">window_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">window_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Fishualizer - no Data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># LAYOUTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_center</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_layout_top</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_layout_top</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_layout_top</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_layout_center</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_layout_top</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_main</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_layout_top</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_splitter</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSplitter</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>

        <span class="c1"># Set background color of window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">setAutoFillBackground</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">palette</span><span class="p">()</span>
        <span class="c1"># palette.setColor(self.MWidget.backgroundRole(),Qt.qRgb(0.2,0.2,0.2))</span>
        <span class="n">palette</span><span class="o">.</span><span class="n">setColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">backgroundRole</span><span class="p">(),</span> <span class="n">Qt</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">qRgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="o">.</span><span class="n">setPalette</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span>

        <span class="c1">#  Try to add certain keyboard shortcuts,</span>
        <span class="c1"># e.g. for toggling between the average activity view and the current data</span>
        <span class="n">play_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+p&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">play_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">play</span><span class="p">)</span>
        <span class="n">layerlimit_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+-&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">layerlimit_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers_scroll_top</span><span class="p">)</span>
        <span class="n">selectcell_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+S&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">selectcell_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_cell</span><span class="p">)</span>
        <span class="n">exportselected_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+E&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">exportselected_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_selected</span><span class="p">)</span>
        <span class="c1"># panleft_shortcut = QtWidgets.QShortcut(&#39;Ctrl+J&#39;, self.main_widget)</span>
        <span class="c1"># panleft_shortcut.activated.connect(self.pan_left)</span>
        <span class="c1"># panright_shortcut = QtWidgets.QShortcut(&#39;Ctrl+L&#39;, self.main_widget)</span>
        <span class="c1"># panright_shortcut.activated.connect(self.pan_right)</span>
        <span class="c1"># panfront_shortcut = QtWidgets.QShortcut(&#39;Ctrl+I&#39;, self.main_widget)</span>
        <span class="c1"># panfront_shortcut.activated.connect(self.pan_front)</span>
        <span class="c1"># panback_shortcut = QtWidgets.QShortcut(&#39;Ctrl+M&#39;, self.main_widget)</span>
        <span class="c1"># panback_shortcut.activated.connect(self.pan_back)</span>
        <span class="c1"># centerview_shortcut = QtWidgets.QShortcut(&#39;Ctrl+K&#39;, self.main_widget)</span>
        <span class="c1"># centerview_shortcut.activated.connect(self.center_view)</span>
        <span class="c1"># switchrotation_shortcut = QtWidgets.QShortcut(&#39;Ctrl+R&#39;, self.main_widget)</span>
        <span class="c1"># switchrotation_shortcut.activated.connect(self.switch_rotation)</span>
        <span class="c1"># selectiontoggle_shortcut = QtWidgets.QShortcut(&#39;Ctrl+T&#39;, self.main_widget)</span>
        <span class="c1"># selectiontoggle_shortcut.activated.connect(self.selection_toggle)</span>
        <span class="c1"># selectioncell_shortcut = QtWidgets.QShortcut(&#39;Ctrl+G&#39;, self.main_widget)</span>
        <span class="c1"># selectioncell_shortcut.activated.connect(self.show_select_cell_dialog)</span>
        <span class="c1"># qtconsole_shortcut = QtWidgets.QShortcut(&#39;Ctrl+Alt+C&#39;, self.main_widget)</span>
        <span class="c1"># qtconsole_shortcut.activated.connect(self.console)</span>
        <span class="n">fwd_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+F&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">fwd_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_fwd</span><span class="p">)</span>
        <span class="n">bwd_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">bwd_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_bwd</span><span class="p">)</span>
        <span class="c1"># hideneuropil_shortcut = QtWidgets.QShortcut(&#39;Ctrl+N&#39;, self.main_widget)</span>
        <span class="c1"># hideneuropil_shortcut.activated.connect(self.toggle_hideneuropil)</span>
        <span class="c1"># videoexport_shortcut = QtWidgets.QShortcut(&#39;Ctrl+Alt+V&#39;, self.main_widget)</span>
        <span class="c1"># videoexport_shortcut.activated.connect(self.video_export)</span>
        <span class="c1"># calciumfit_shortcut = QtWidgets.QShortcut(&#39;Ctrl+Y&#39;, self.main_widget)</span>
        <span class="c1"># calciumfit_shortcut.activated.connect(self.toggle_calcium_fit)</span>
        <span class="n">showregioncurrentcell_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+Alt+G&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">showregioncurrentcell_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_region_current_cell</span><span class="p">)</span>
        <span class="n">swapcoloraxis_shortcut</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QShortcut</span><span class="p">(</span><span class="s1">&#39;Ctrl+C&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="n">swapcoloraxis_shortcut</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swap_color_axis</span><span class="p">)</span>

        <span class="c1"># Create Center Viewer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span> <span class="o">=</span> <span class="n">GLViewWidgetPos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>

        <span class="c1"># Add 3 grids to the plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">iG</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">[</span><span class="n">iG</span><span class="p">]</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLGridItem</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">[</span><span class="n">iG</span><span class="p">]</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">[</span><span class="n">iG</span><span class="p">]</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">[</span><span class="n">iG</span><span class="p">]</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="n">iG</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iG</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iG</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">[</span><span class="n">iG</span><span class="p">])</span>

        <span class="c1"># Create Play Button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">setCheckable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">play</span><span class="p">)</span>

        <span class="c1"># Create slider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSlider</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>  <span class="c1"># QScrollBar(QtCore.Qt.Horizontal)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_scroll</span><span class="p">)</span>  <span class="c1"># Callback function for scrollbar value change</span>

        <span class="c1"># Create Frame spin box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>  <span class="c1"># QtWidgets.QLineEdit(&#39;0&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_set</span><span class="p">)</span>
        <span class="c1"># self.frame_le.editingFinished.connect(self.time_set)</span>

        <span class="c1"># LIMIT THE VIEW</span>
        <span class="c1"># EDIT TOP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_stop</span><span class="p">)</span>

        <span class="c1"># EDIT BOTTOM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_start</span><span class="p">)</span>

        <span class="c1"># SCROLLBARS</span>
        <span class="c1"># TOP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollBar</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="o">.</span><span class="n">setInvertedAppearance</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># BOTTOM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QScrollBar</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_start_scroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="o">.</span><span class="n">setInvertedAppearance</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># short cuts for selecting the slicing direction</span>
        <span class="c1"># limitx_shortcut = QtWidgets.QShortcut(&#39;Ctrl+1&#39;, self.main_widget)</span>
        <span class="c1"># limitx_shortcut.activated.connect(self.limitx)</span>
        <span class="c1"># limity_shortcut = QtWidgets.QShortcut(&#39;Ctrl+2&#39;, self.main_widget)</span>
        <span class="c1"># limity_shortcut.activated.connect(self.limity)</span>
        <span class="c1"># limitz_shortcut = QtWidgets.QShortcut(&#39;Ctrl+3&#39;, self.main_widget)</span>
        <span class="c1"># limitz_shortcut.activated.connect(self.limitz)</span>

        <span class="c1"># short cuts for selecting the slicing direction</span>
        <span class="c1"># tmp = QtWidgets.QShortcut(&#39;Ctrl+Alt+1&#39;, self.main_widget)</span>
        <span class="c1"># tmp.activated.connect(self.viewyz)</span>
        <span class="c1"># tmp = QtWidgets.QShortcut(&#39;Ctrl+Alt+2&#39;, self.main_widget)</span>
        <span class="c1"># tmp.activated.connect(self.viewxz)</span>
        <span class="c1"># tmp = QtWidgets.QShortcut(&#39;Ctrl+Alt+3&#39;, self.main_widget)</span>
        <span class="c1"># tmp.activated.connect(self.viewxy)</span>

        <span class="c1"># COLORMAP SELECTOR for selecting Activity Scale (left/right click)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_alphamap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_color</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_color</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mpl_cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span> <span class="o">=</span> <span class="n">ColorRangePicker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">top_limit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">bottom_limit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start</span><span class="p">)</span>

        <span class="c1"># COLORMAP  STOP EDIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>  <span class="c1"># QLineEdit(&#39;0&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># self.LimitColorStartE.setMaximumWidth(30)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_colorbar_stop</span><span class="p">)</span>

        <span class="c1"># COLORMAP  START EDIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>  <span class="c1"># QLineEdit(&#39;0&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># self.LimitColorStartE.setMaximumWidth(30)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_colorbar_start</span><span class="p">)</span>

        <span class="c1"># Create Alpha Value selector via Colormap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_sel_cp</span> <span class="o">=</span> <span class="n">ColorRangePicker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_map</span><span class="p">)</span>  <span class="c1"># change to gray gradient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_sel_cp</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_sel_cp</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_sel_cp</span><span class="o">.</span><span class="n">top_limit</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_setter</span><span class="p">)</span>  <span class="c1"># connect to callback that sets the overall alpha value</span>

        <span class="c1"># Create Checkbox Group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QGroupBox</span><span class="p">(</span><span class="s1">&#39;Visual Options&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>

        <span class="c1"># Dropdown menu with data selection options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="p">)</span>

        <span class="c1"># Button to add additional options to data selection dropdown menu (self.DataSel)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_data_btn</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Add static Data&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_data_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_static_gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_data_btn</span><span class="p">)</span>
        <span class="c1"># adddata_shortcut = QtWidgets.QShortcut(&#39;Ctrl+A&#39;,self.MWidget)</span>
        <span class="c1"># adddata_shortcut.activated.connect(self.load_static)</span>

        <span class="c1"># Region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s1">&#39;Regions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_show</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span> <span class="o">=</span> <span class="n">ExtendedComboBox</span><span class="p">()</span>  <span class="c1"># QtWidgets.QComboBox()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="s1">&#39;Labelled only&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_labelled</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options_box</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">button_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_box</span><span class="o">.</span><span class="n">setMaximumHeight</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>

        <span class="c1"># Behavior + Neuronal activity plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_plot</span> <span class="o">=</span> <span class="n">DockArea</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_dock</span> <span class="o">=</span> <span class="n">Dock</span><span class="p">(</span><span class="s1">&#39;Stimulus and Behavior&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_dock</span> <span class="o">=</span> <span class="n">Dock</span><span class="p">(</span><span class="s1">&#39;Neuronal Activity&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_plot</span><span class="o">.</span><span class="n">addDock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_dock</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_plot</span><span class="o">.</span><span class="n">addDock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_dock</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beh_dock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_plot</span><span class="o">.</span><span class="n">moveDock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_dock</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_dock</span><span class="p">)</span>
        <span class="c1"># Behavior plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setYRange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># XXRange YRange: default values, are updated upon data loading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setXRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;stimulus and behavior&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># self.behavior_pw.getAxis(&#39;left&#39;).setPen(pg.mkPen(color=&#39;r&#39;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">showAxis</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>  <span class="c1"># use non-used right axis for mean selections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;df/f of selection&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">hideButtons</span><span class="p">()</span>  <span class="c1"># The innate functionality of the &#39;A&#39;-button is hidden, because it is not compatible with the current lay-out (due to multiple viewboxes?)</span>

        <span class="sd">&quot;&quot;&quot;To add DF/F data in behavior/stimulus plot, two different scales are</span>
<span class="sd">        needed for visibility. DF/F data can be plotted by using the &#39;hide points&#39;</span>
<span class="sd">        functionality (i.e. edit_hide()).</span>
<span class="sd">        To do this one needs to put plots in ViewBoxes, and link these VBs to</span>
<span class="sd">        the main widget (behavior_pw)</span>

<span class="sd">        #TODO: There is still one issue; which is that stimulus_plot and</span>
<span class="sd">        behavior_plot overload the left axis of behavior_pw. This is relevant for</span>
<span class="sd">        data sets containing both behavioral and stimulus data. Currently</span>
<span class="sd">        stimulus_plot is prioritized. This could maybe be solved by allowing an</span>
<span class="sd">        additional third axis (second on the left), but that is more involved..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ViewBox</span><span class="p">()</span>  <span class="c1"># Viewbox for plot of stimulus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ViewBox</span><span class="p">()</span>  <span class="c1"># Viewbox for plot of behavior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ViewBox</span><span class="p">()</span>  <span class="c1"># ViewBox for plot of single df signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="p">)</span>  <span class="c1"># add ViexBox to PW</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">linkToView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">linkToView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">linkToView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="p">)</span>  <span class="c1"># connect axis to VB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="o">.</span><span class="n">setXLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="o">.</span><span class="n">setXLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">setXLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="p">)</span>  <span class="c1"># DF and stim/behav link by time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">sigRangeChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_plot</span><span class="p">)</span>  <span class="c1"># connect so that VB scales with PW</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beh_time</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">InfiniteLine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">movable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_time</span><span class="o">.</span><span class="n">sigPositionChangeFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_time_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_dock</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Behavior (white), Stimulus (red)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">invertY</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># It is still not so clear to me why this is needed, but it does the trick.!</span>

        <span class="c1"># Activity plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plots</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(),</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">()]</span>  <span class="c1"># raw calcium signal</span>
        <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plots</span><span class="p">[</span><span class="n">iP</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(),</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">()]</span>  <span class="c1"># deconvolved spikes</span>
        <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span><span class="p">[</span><span class="n">iP</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(),</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">()]</span>  <span class="c1"># calcium fit by decovolved spikes</span>
        <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span><span class="p">[</span><span class="n">iP</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>  <span class="c1"># same color as corresponding spikes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">setYRange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_time</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">InfiniteLine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">movable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_time</span><span class="o">.</span><span class="n">sigPositionChangeFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_time_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_dock</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Neuron&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_text</span><span class="p">)</span>

        <span class="c1"># LAYOUT</span>
        <span class="c1"># Splitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">area_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_splitter</span><span class="o">.</span><span class="n">setStretchFactor</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 3D Widget</span>
        <span class="c1"># self.v_layout_center.addWidget(self.View3D)  # ,ViewerY,ViewerX,ViewerH,ViewerW)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_center</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_splitter</span><span class="p">)</span>  <span class="c1"># ,ViewerY,ViewerX,ViewerH,ViewerW)</span>
        <span class="c1"># Time scroll bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_center</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="p">)</span>  <span class="c1"># ,ViewerY+ViewerH,1,1,DivX-2)</span>
        <span class="c1"># Space range selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="p">)</span>  <span class="c1"># ,0,0,1,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="p">)</span>  <span class="c1"># ,1,0,2,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="p">)</span>  <span class="c1"># ,3,0,2,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="p">)</span>  <span class="c1"># ,ViewerY+ViewerH-1,0,1,1)</span>
        <span class="c1"># Play button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_left</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="p">)</span>  <span class="c1"># ,ViewerY+ViewerH,0,1,1)</span>
        <span class="c1"># Color bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="p">)</span>  <span class="c1"># ,0,DivX-1,1,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="p">)</span>  <span class="c1"># ,1,DivX-1,ViewerH-alpha_h-2,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="p">)</span>  <span class="c1"># ,ViewerH-alpha_h-1,DivX-1,1,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_sel_cp</span><span class="p">)</span>  <span class="c1"># ,ViewerH-alpha_h,DivX-1,alpha_h,1)</span>
        <span class="c1"># Time text display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_right</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="p">)</span>  <span class="c1"># ,ViewerY+ViewerH,DivX-1,1,1)</span>
        <span class="c1"># Options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_layout_main</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options_box</span><span class="p">)</span>  <span class="c1"># ,ViewerY+ViewerH+1,0,1,DivX)</span>

        <span class="c1"># Other dialog boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_cell_dialog</span> <span class="o">=</span> <span class="n">SelectCellDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_data_dialog</span> <span class="o">=</span> <span class="n">StaticDataDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span> <span class="o">=</span> <span class="n">CorrelationDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortcuts_dialog</span> <span class="o">=</span> <span class="n">ShortcutsDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Jupyter kernel for external console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">InternalIPKernel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">init_ipkernel</span><span class="p">(</span><span class="s1">&#39;qt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Video writer for export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Viewer.closeEvent"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a0</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCloseEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;closeEvent of Viewer.</span>

<span class="sd">        Calls leaving() to close kernel and then closes the UI&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaving</span><span class="p">()</span>
        <span class="n">a0</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.leaving"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.leaving">[docs]</a>    <span class="k">def</span> <span class="nf">leaving</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the iPython console.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">ipkernel</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.console"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.console">[docs]</a>    <span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an iPython console&quot;&quot;&quot;</span>
        <span class="c1"># DONE: Do not create if one already exists.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qt_console</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">new_qt_console</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.cluster_color"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.cluster_color">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.make_cmap"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.make_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">make_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a color map&quot;&quot;&quot;</span>
        <span class="c1"># color = np.array([(0, 0, 255, self.alpha*255), (128, 0, 128, self.alpha*255),</span>
        <span class="c1">#                   (255, 0, 0, self.alpha*255),(255, 255, 255, self.alpha*255)],</span>
        <span class="c1">#                  dtype=np.ubyte)  # Define the color at the stop points, here for a fire like colormap</span>
        <span class="c1"># color = np.array(plt.cm.inferno.colors)*255</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpl_cmap</span> <span class="o">==</span> <span class="s1">&#39;GFP&#39;</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">color</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mpl_cmap</span><span class="p">)</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">color</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="p">[</span><span class="mi">255</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">]</span> <span class="o">*</span> <span class="n">color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_color</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_color</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Define stop points on the color map, on the [0, 1] range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">:</span>  <span class="c1"># defined as None when Fishualizer initiates</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]:</span>  <span class="c1"># if swap == True, reverse color axis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ColorMap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">color</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># reverse (what we were used to)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ColorMap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">color</span><span class="p">[::</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># normal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ColorMap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">color</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Viewer.make_alphamap"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.make_alphamap">[docs]</a>    <span class="k">def</span> <span class="nf">make_alphamap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a transparency map&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>  <span class="c1"># Define stop points on the color map, on the [0, 1] range</span>
        <span class="c1"># Define the color at the stop points</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_map</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ColorMap</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span></div>

<div class="viewcode-block" id="Viewer.reset_view"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.reset_view">[docs]</a>    <span class="k">def</span> <span class="nf">reset_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.set_perspective_3d"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.set_perspective_3d">[docs]</a>    <span class="k">def</span> <span class="nf">set_perspective_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set perspective of self.view3D to a 3D view (default).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span></div>

<div class="viewcode-block" id="Viewer.set_perspective_2d"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.set_perspective_2d">[docs]</a>    <span class="k">def</span> <span class="nf">set_perspective_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set perspective of self.view3D to a 2D view. This is done by effectively</span>
<span class="sd">        moving out (increase distance) and zooming in (decrease fov).</span>
<span class="sd">        The smaller self.view3D.opts[&#39;fov&#39;] is, the closer one comes to a 2D view,</span>
<span class="sd">        but rendering might be slower for very small values of fov.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># hard-coded here, could be changed manually in console.</span></div>

<div class="viewcode-block" id="Viewer.switch_alpha_mode"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.switch_alpha_mode">[docs]</a>    <span class="k">def</span> <span class="nf">switch_alpha_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.edit_cmap"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.edit_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">edit_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.edit_hide"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.edit_hide">[docs]</a>    <span class="k">def</span> <span class="nf">edit_hide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.compute_correlation_gui"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.compute_correlation_gui">[docs]</a>    <span class="k">def</span> <span class="nf">compute_correlation_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.help_shortcuts"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.help_shortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">help_shortcuts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the shortcut dialog pop up.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortcuts_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.help_log"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.help_log">[docs]</a>    <span class="k">def</span> <span class="nf">help_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the logger.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_win</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.add_static_gui"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.add_static_gui">[docs]</a>    <span class="k">def</span> <span class="nf">add_static_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.show_select_cell_dialog"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.show_select_cell_dialog">[docs]</a>    <span class="k">def</span> <span class="nf">show_select_cell_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the select cell dialog.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_cell_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="Viewer.plot_time_changed"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.plot_time_changed">[docs]</a>    <span class="k">def</span> <span class="nf">plot_time_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.time_scroll"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.time_scroll">[docs]</a>    <span class="k">def</span> <span class="nf">time_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.time_set"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.time_set">[docs]</a>    <span class="k">def</span> <span class="nf">time_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.select_data_file"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.select_data_file">[docs]</a>    <span class="k">def</span> <span class="nf">select_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.update_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.update_plot">[docs]</a>    <span class="k">def</span> <span class="nf">update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.layers_scroll_top"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.layers_scroll_top">[docs]</a>    <span class="k">def</span> <span class="nf">layers_scroll_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.layers_scroll_bottom"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.layers_scroll_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">layers_scroll_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.play"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.play">[docs]</a>    <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.video_export"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.video_export">[docs]</a>    <span class="k">def</span> <span class="nf">video_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.grab_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.grab_plot">[docs]</a>    <span class="k">def</span> <span class="nf">grab_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.color_top_limit"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.color_top_limit">[docs]</a>    <span class="k">def</span> <span class="nf">color_top_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.color_bottom_limit"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.color_bottom_limit">[docs]</a>    <span class="k">def</span> <span class="nf">color_bottom_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.regionchange"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.regionchange">[docs]</a>    <span class="k">def</span> <span class="nf">regionchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.regionconfirmed"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.regionconfirmed">[docs]</a>    <span class="k">def</span> <span class="nf">regionconfirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.selection_change"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.selection_change">[docs]</a>    <span class="k">def</span> <span class="nf">selection_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.add_data"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.add_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.fast_deconvolv"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.fast_deconvolv">[docs]</a>    <span class="k">def</span> <span class="nf">fast_deconvolv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.toggle_calcium_fit"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.toggle_calcium_fit">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_calcium_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.show_region_current_cell"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.show_region_current_cell">[docs]</a>    <span class="k">def</span> <span class="nf">show_region_current_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.toggle_hideneuropil"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.toggle_hideneuropil">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_hideneuropil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.swap_color_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.swap_color_axis">[docs]</a>    <span class="k">def</span> <span class="nf">swap_color_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.update_behavior_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.update_behavior_plot">[docs]</a>    <span class="k">def</span> <span class="nf">update_behavior_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.call_reverse_z_coords"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.call_reverse_z_coords">[docs]</a>    <span class="k">def</span> <span class="nf">call_reverse_z_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.inverse_x_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.inverse_x_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_x_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.inverse_y_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.inverse_y_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_y_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.inverse_z_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.inverse_z_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_z_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.draw_xy_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.draw_xy_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_xy_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.draw_xz_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.draw_xz_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_xz_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.draw_yz_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.draw_yz_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_yz_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.limitx"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.limitx">[docs]</a>    <span class="k">def</span> <span class="nf">limitx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.limity"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.limity">[docs]</a>    <span class="k">def</span> <span class="nf">limity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.limitz"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.limitz">[docs]</a>    <span class="k">def</span> <span class="nf">limitz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.change_region_view"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.change_region_view">[docs]</a>    <span class="k">def</span> <span class="nf">change_region_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Viewer.change_playtimer_interval"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Viewer.change_playtimer_interval">[docs]</a>    <span class="k">def</span> <span class="nf">change_playtimer_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_color</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stop_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_color</span></div>


<span class="c1"># noinspection PyUnresolvedReferences</span>
<div class="viewcode-block" id="Fishualizer"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer">[docs]</a><span class="k">class</span> <span class="nc">Fishualizer</span><span class="p">(</span><span class="n">Viewer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actual class defining the GUI behavior. This class will be instantiated to create the main window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create and initialize window</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Fishualizer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># parse input arguments</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Fishualizer&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;datafile&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to h5 datafile&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--visstyle&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;transparent&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Visualization Option&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dataformat&#39;</span><span class="p">,</span><span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;cellsXtimes&#39;</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timesXcells&#39;</span><span class="p">,</span><span class="s1">&#39;cellsXtimes&#39;</span><span class="p">],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Format of the calcium data. Possibilities are timesXcells or cellsXtimes (default)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignorelags&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore the time lags provided across layers&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--forceinterpolation&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Force redoing the interpolation (useful for debugging)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignoreunknowndata&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore data sets that are not recognised automatically&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="c1"># Parameters and constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_times</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of time points in the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Current time point viewed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_time</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Maximum length of the video</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Current Frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_selection</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># this is overwritten in load_data(), but needed for pre data load selection_change() (when switching between data sets) in load_data()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># default to swap (reverse color scale)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">=</span> <span class="s1">&#39;df&#39;</span>  <span class="c1"># set default data_set (should be same as default QComboBox Button)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selection_updated</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_on_play</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labelled_only</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_hull</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_x_axis</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># coordinate system axes, are initiated in update_coordinate_system()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_y_axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_z_axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_bar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># Path to the data file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pointer to the 3D plot.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Loaded data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ROI hull</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_roi</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Current ROI index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha_mode</span> <span class="o">=</span> <span class="s1">&#39;additive&#39;</span>  <span class="c1"># Current color blending mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span> <span class="o">=</span> <span class="n">Zecording</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,{</span><span class="s1">&#39;dataformat&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataformat</span><span class="p">,</span> <span class="s1">&#39;ignorelags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignorelags</span><span class="p">,</span>
                              <span class="s1">&#39;forceinterpolation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">forceinterpolation</span><span class="p">,</span> <span class="s1">&#39;ignoreunknowndata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignoreunknowndata</span><span class="p">})</span>  <span class="c1"># Zecording object</span>
        <span class="c1"># Initialize a QTimer used to play the movie.</span>
        <span class="c1"># Here the time interval is fixed but could be made into a setting in the GUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">((</span><span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate</span><span class="p">))</span>  <span class="c1"># Interval between frames in ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">animate</span><span class="p">)</span>  <span class="c1"># Connect the Timer to a callback function called every x ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">animate_mode</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>  <span class="c1"># mode used in self.animate()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_animate_azimuth_step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Initialize a QTimer used to export a movie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">1000</span> <span class="o">//</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># Interval between frames in ms (60 frames per sec)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_recording</span><span class="p">)</span>  <span class="c1"># Connect the Timer to a callback function called every x ms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Fishualizer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotopts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;centered&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="c1"># Just a suggestion on how to handle multiple file types. HDF5 is probably the best choice for large data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opening_data_methods</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.csv&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">,</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="s1">&#39;.npz&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="s1">&#39;.h5&#39;</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize_scrollbar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hull_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># TODO why do we need two hull colors?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">82</span><span class="p">,</span> <span class="o">.</span><span class="mi">82</span><span class="p">,</span> <span class="o">.</span><span class="mi">82</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># grey color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_zbrain_divisions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">259</span><span class="p">,</span> <span class="mi">274</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">panstep</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;df&#39;</span><span class="p">}</span>  <span class="c1"># , 1: &#39;spikes&#39;} # predefined datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of predefined data sets (with zero-indexing)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_neuropil</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># if &#39;on&#39;, only the neurons in neurons_show are well visible, if False regular Fishualizer (all neurons)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl_colors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fishlog&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span> <span class="o">=</span> <span class="n">RotatingFileHandler</span><span class="p">(</span><span class="s1">&#39;Fishualizer.log&#39;</span><span class="p">,</span> <span class="n">maxBytes</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> :: </span><span class="si">%(filename)s</span><span class="s1"> :: </span><span class="si">%(funcName)s</span><span class="s1"> :: line </span><span class="si">%(lineno)d</span><span class="s1"> :: </span><span class="si">%(levelname)s</span><span class="s1"> :: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">:%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_win</span> <span class="o">=</span> <span class="n">LogWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_win</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Init is over&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Initialization is finished&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">handle_exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowIcon</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;icon.png&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">datafile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">datafile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<div class="viewcode-block" id="Fishualizer.closeEvent"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a0</span><span class="p">:</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QCloseEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;closeEvent of Fishualizer.</span>

<span class="sd">        This function is called automatically if UI is closed.</span>
<span class="sd">        Closes rec class, informs logger and calls Viewer.closeEvent() which</span>
<span class="sd">        further handles closing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File closed&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">closeEvent</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.select_data_file"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.select_data_file">[docs]</a>    <span class="k">def</span> <span class="nf">select_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function called to open a data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open a dialog box in the current directory and filter a few possible extensions</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;data_path&#39;</span><span class="p">]</span>  <span class="c1"># os.getcwd()</span>
        <span class="c1"># file_dialog = QtWidgets.QFileDialog(self, &#39;Choose a data file&#39;, cwd, &#39;Data (*.h5)&#39;)</span>
        <span class="n">file_dialog</span> <span class="o">=</span> <span class="n">OpenDataDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Choose a data file&#39;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;Data (*.h5)&#39;</span><span class="p">)</span>
        <span class="n">dpath</span><span class="p">,</span> <span class="n">_filter</span><span class="p">,</span> <span class="n">ignorelags</span><span class="p">,</span> <span class="n">forceinterp</span><span class="p">,</span> <span class="n">ignoreunknowndata</span><span class="p">,</span> <span class="n">dformat</span> <span class="o">=</span> <span class="n">file_dialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                                                        <span class="s2">&quot;Choose a data file&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;Data (*.h5)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignorelags</span> <span class="o">=</span> <span class="n">ignorelags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">forceinterpolation</span> <span class="o">=</span> <span class="n">forceinterp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignoreunknowndata</span> <span class="o">=</span> <span class="n">ignoreunknowndata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataformat</span> <span class="o">=</span> <span class="n">dformat</span>
        <span class="k">if</span> <span class="n">dpath</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># Save the data path folder for later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
            <span class="c1"># Set the new data path. The data_path setter will take care of the rest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">dpath</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alpha_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha_mode</span>

    <span class="nd">@alpha_mode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alpha_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property that is the current transparency modes.</span>

<span class="sd">        The setter function checks if self.Plot3D exists, changes its GLOption and</span>
<span class="sd">        calls update_plot().</span>

<span class="sd">        Parameter:</span>
<span class="sd">        -----------</span>
<span class="sd">            value: str (pre-defined)</span>
<span class="sd">                new alpha mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha_mode</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="o">.</span><span class="n">setGLOptions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c1">#self.update_plot()  # setGLOptions() already updates the plot</span>

<div class="viewcode-block" id="Fishualizer.switch_alpha_mode"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.switch_alpha_mode">[docs]</a>    <span class="k">def</span> <span class="nf">switch_alpha_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the transparency mode via property self.alpha_mode</span>

<span class="sd">        Parameter:</span>
<span class="sd">        ----------</span>
<span class="sd">            mode: str, (predefined)</span>
<span class="sd">                &#39;additive&#39;</span>
<span class="sd">                &#39;translucent&#39;</span>
<span class="sd">                &#39;opaque&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">def</span> <span class="nf">save_checking</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;set action to check, but block signals while doing so (to prevent</span>
<span class="sd">            recurrently calling switch_alpha_mode()).&quot;&quot;&quot;</span>
            <span class="n">action</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># uncheck all options</span>
        <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_action</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o_action</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;additive&#39;</span><span class="p">:</span>  <span class="c1"># check the current option</span>
            <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_action</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;translucent&#39;</span><span class="p">:</span>
            <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_action</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;opaque&#39;</span><span class="p">:</span>
            <span class="n">save_checking</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o_action</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Fishualizer.time_scroll"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.time_scroll">[docs]</a>    <span class="k">def</span> <span class="nf">time_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function updating the plot when scroll bar is moved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">time_scroll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">value</span><span class="p">()</span></div>
        <span class="c1"># self.current_time = float(self.current_frame)/self.rec.sampling_rate</span>

<div class="viewcode-block" id="Fishualizer.limit_color_stop"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_color_stop">[docs]</a>    <span class="k">def</span> <span class="nf">limit_color_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback handling the setting of the bottom_limit of the color map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos: float</span>
<span class="sd">            Relative position of the click (between 0 and 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_color</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_color</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_color</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_color</span> <span class="o">=</span> <span class="n">pos</span>  <span class="c1"># New stop position. Will update the color map automagically</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span>  <span class="c1"># Set the colormap in the colorpicker</span></div>

<div class="viewcode-block" id="Fishualizer.limit_color_start"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_color_start">[docs]</a>    <span class="k">def</span> <span class="nf">limit_color_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback handling the setting of the top_limit of the color map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos: float</span>
<span class="sd">            Relative position of the click (between 0 and 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_color</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_color</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_color</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_color</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span></div>

<div class="viewcode-block" id="Fishualizer.limit_colorbar_start"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_colorbar_start">[docs]</a>    <span class="k">def</span> <span class="nf">limit_colorbar_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to change the value of self.disp_start of current data set</span>

<span class="sd">        This function is called by valueChanged of limit_color_start_sb (user numerical input QSpinBox)</span>
<span class="sd">        It also updates the cmap and the plot.</span>

<span class="sd">        Parameter:</span>
<span class="sd">        -----------</span>
<span class="sd">            value: float</span>
<span class="sd">                new value of disp_start</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># text = self.LimitColorStartE.text()</span>
        <span class="c1"># if len(text)&gt;0:</span>
        <span class="c1">#     if self.LimitColorStartE.isModified():</span>
        <span class="c1">#         self.disp_start[self.data_set] = float(text)</span>
        <span class="c1">#         self.update_plot()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limit_colorbar_stop"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_colorbar_stop">[docs]</a>    <span class="k">def</span> <span class="nf">limit_colorbar_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to change the value of self.disp_stop</span>

<span class="sd">        This function is called by valueChanged of limit_color_stop_sb (user numerical input QSpinBox)</span>
<span class="sd">        It also updates the cmap and the plot.</span>

<span class="sd">        Parameter:</span>
<span class="sd">        -----------</span>
<span class="sd">            value: float</span>
<span class="sd">                new value of disp_stop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># text = self.LimitColorStopE.text()</span>
        <span class="c1"># if len(text)&gt;0:</span>
        <span class="c1">#     if self.LimitColorStopE.isModified():</span>
        <span class="c1">#         self.disp_stop[self.data_set] = float(text)</span>
        <span class="c1">#         self.update_plot()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.time_set"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.time_set">[docs]</a>    <span class="k">def</span> <span class="nf">time_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function updating the plot when a time is entered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">value</span></div>
        <span class="c1"># text = self.frame_le.text()</span>
        <span class="c1"># if len(text) &gt; 0:</span>
        <span class="c1">#     if self.frame_le.isModified():</span>
        <span class="c1">#        self.current_time = float(text)</span>
        <span class="c1"># self.current_frame = int(self.current_time * self.rec.sampling_rate)</span>

<div class="viewcode-block" id="Fishualizer.step_fwd"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.step_fwd">[docs]</a>    <span class="k">def</span> <span class="nf">step_fwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step one frame forwards in time&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sampling_rate</span></div>

<div class="viewcode-block" id="Fishualizer.step_bwd"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.step_bwd">[docs]</a>    <span class="k">def</span> <span class="nf">step_bwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Step one frame backwards in time&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sampling_rate</span></div>

<div class="viewcode-block" id="Fishualizer.alpha_setter"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.alpha_setter">[docs]</a>    <span class="k">def</span> <span class="nf">alpha_setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback handling the setting of a new alpha value through the alpha selector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos: float</span>
<span class="sd">            Relative position of the click (between 0 and 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">pos</span></div>

<div class="viewcode-block" id="Fishualizer.make_cmap"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.make_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">make_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the color map in response to a change in start/stop/alpha value and update the plot accordingly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_color</span>

    <span class="nd">@start_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">start_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start color value of variable color range bar. Also update cmap in setter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_color</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>  <span class="c1"># update the colormap to reflect the new start color</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stop_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_color</span>

    <span class="nd">@stop_color</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">stop_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop color value of variable color range bar. Also update cmap in setter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_color</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>  <span class="c1"># update the colormap to reflect the new stop color</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span>

    <span class="nd">@alpha</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property with the value of alpha (transparency)</span>

<span class="sd">        The setter updates the value and also calls self.make_cmap() to update</span>

<span class="sd">        Paramter:</span>
<span class="sd">            value: float</span>
<span class="sd">                new value for alpha (min=0, max=1, but values outside this range</span>
<span class="sd">                are also handled)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>  <span class="c1"># update the colormap to reflect the new alpha value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span>

    <span class="nd">@current_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the new current time. Values are clipped between 0 and the maximal time.</span>
<span class="sd">        Current frame is automatically updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span>

    <span class="nd">@current_frame</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the new current frame. Values are clipped between 0 and the number of frames</span>
<span class="sd">        Current time is automatically updated.</span>
<span class="sd">        Scrollbar position and frame number text are updated</span>
<span class="sd">        Plot is refreshed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value: int</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_frame</span><span class="p">)</span>
        <span class="c1"># self.frame_le.setText(str(self._current_time))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sampling_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beh_time</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_time</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>

<div class="viewcode-block" id="Fishualizer.load_data"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the data file and load the data</span>

<span class="sd">        Set the self.rec attribute whose setter will take care of the rest</span>
<span class="sd">        Plot the behavior/stimulus plot</span>
<span class="sd">        Add labels to menu if labels are available</span>
<span class="sd">        Set current self.view3D=None and let update_plot() make a new self.view3D</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading data...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Loading data ...&#39;</span><span class="p">)</span>
        <span class="c1"># Get the extension</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="c1"># set back to default,</span>
        <span class="c1"># because if data is changed while running from sampledata_spike to sampledata it would crash otherwise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># change button</span>
        <span class="c1"># remove all options other than &#39;df&#39; from dropdown menu  (convenient when changing between datasets)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span><span class="p">)</span>  <span class="c1"># remove last (remaining) item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># decrease until only self.iDataSet = 0 is left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;df&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">=</span> <span class="s1">&#39;df&#39;</span>  <span class="c1"># set default data_set (should be same as default QComboBox Button)</span>

        <span class="c1"># Open the recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span> <span class="o">=</span> <span class="n">Zecording</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,{</span><span class="s1">&#39;dataformat&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataformat</span><span class="p">,</span> <span class="s1">&#39;ignorelags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignorelags</span><span class="p">,</span>
                             <span class="s1">&#39;forceinterpolation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">forceinterpolation</span><span class="p">,</span> <span class="s1">&#39;ignoreunknowndata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">ignoreunknowndata</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fishualizer - </span><span class="si">{self.data_path}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span> <span class="ow">and</span> <span class="s1">&#39;ref_coords&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Choose one coordinate set by manual input. Save as data_plot, this parameter</span>
<span class="sd">            is now used throughout the code.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span> <span class="k">if</span>
                       <span class="s1">&#39;coords&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># possible input names containing &#39;coords&#39;</span>
            <span class="n">choice_input_name</span><span class="p">,</span> <span class="n">ok_pressed</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Coordinate choice&quot;</span><span class="p">,</span>
                                                                           <span class="s2">&quot;What coordinate set should be used?&quot;</span><span class="p">,</span>
                                                                           <span class="n">choices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">default_name</span><span class="p">,</span> <span class="n">input_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">data_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># loop through mappings to find corresponding default name</span>
                <span class="k">if</span> <span class="n">input_name</span> <span class="o">==</span> <span class="n">choice_input_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">default_name</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Using </span><span class="si">{choice_input_name}</span><span class="s1"> as coordinates&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span> <span class="ow">and</span> <span class="s1">&#39;ref_coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="c1"># self.data_plot = &#39;coords&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coords</span>
        <span class="k">elif</span> <span class="s1">&#39;ref_coords&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span> <span class="ow">and</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="c1"># self.data_plot = &#39;ref_coords&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ref_coords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="p">)</span>  <span class="c1"># clear previous legen</span>

        <span class="k">if</span> <span class="s1">&#39;behavior&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Arrange plotting of behavior and/or stimulus</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;stimulus&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>  <span class="c1"># stimulus and behavior</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setYRange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">))</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># lay out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Behavior (yellow), Stimulus (red)&#39;</span><span class="p">,</span>
                                                 <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># move because stimulus and behavior can vary greatly in magnitude (dependent on physical unit)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only behavior</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setYRange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># lay out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Behavior (yellow)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">behavior</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;stimulus&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>  <span class="c1"># only stimulus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setYRange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># lay out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Stimulus (red)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># no stimulus or behavior</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">TextItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;No behavior or stimulus to display&#39;</span><span class="p">,</span>
                                             <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="o">.</span><span class="n">setPos</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">setXRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beh_stim_text</span><span class="p">)</span>  <span class="c1"># add now instead of at the beginning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear mean trace (if there is one left from preivous data set)</span>
        <span class="n">coordnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;x_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coord&#39;</span><span class="p">,</span> <span class="s1">&#39;z_coord&#39;</span><span class="p">)</span>  <span class="c1">#TODO: Is this still necessary? T: I would remove this ?</span>
        <span class="k">for</span> <span class="n">iC</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">dataname</span> <span class="o">=</span> <span class="n">coordnames</span><span class="p">[</span><span class="n">iC</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="p">,</span> <span class="n">dataname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="n">iC</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">_avail_data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>  <span class="c1"># add option to dropdown menu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increase index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataname</span>  <span class="c1"># add dataname to overview of data names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="n">iC</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="n">iC</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;spikes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="c1"># define like this so it does not crash when SampleData without spikes is loaded</span>
            <span class="c1"># Add &#39;spikes&#39; option to dropdown menu and data_names dictionary</span>
            <span class="c1"># so if you do not load spikes, it does not appear as option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s1">&#39;spikes&#39;</span><span class="p">)</span>  <span class="c1"># add option to dropdown menu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increase index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spikes&#39;</span>  <span class="c1"># add dataname to overview of data names</span>

        <span class="k">if</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># no labels in hdf5 file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No Labels Found at in hdf5 file&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Labels Found in hdf5 file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Open association between labels and indices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Content/RegionLabels.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">F2</span><span class="p">:</span>  <span class="c1"># load in labelnames</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">F2</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># block signals while adding new items to the qcombobox in regions_add() because this will call region_change() everytime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear previous entries (if any)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regions_add</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labelled_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data loading done.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Data loading is done.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... done.&#39;</span><span class="p">)</span>

        <span class="c1"># Remove old plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Assign Times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_times</span><span class="p">,</span> <span class="mi">100</span><span class="p">)))])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># mean of some random time points</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            T: We talked about not calcuting full statistics (e.g. percentile)</span>
<span class="sd">            because it takes long to calculate. Now the mean of 5 time points,</span>
<span class="sd">            all neurons is used to disambiguate between calcium and deconvolved</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">])</span>

        <span class="c1"># add other keys as well so they can be plotted as well (needs finetuning):</span>
        <span class="k">if</span> <span class="s1">&#39;spikes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="s1">&#39;spikes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="s1">&#39;spikes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="s1">&#39;spikes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_min</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_action_max</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_view_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_cluster_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Assign Slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># find limits of the current data set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_nsteps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cInd</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="n">cInd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_start_abs</span><span class="p">[</span><span class="n">cInd</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop_abs</span><span class="p">[</span><span class="n">cInd</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_nsteps</span><span class="p">[</span><span class="n">cInd</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_nsteps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_start_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_stop_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Z slider intially selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitz</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">()</span>

        <span class="c1"># Set maximum of frame_sb spinbox (defaults otherwise to 99)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_spb</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># suffices while Sampling Frequency &gt; 1Hz</span>

        <span class="c1"># Perform first redraw of the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_menu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>
        <span class="c1"># self.recomputeBackdrops()</span>

<div class="viewcode-block" id="Fishualizer.limitx"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limitx">[docs]</a>    <span class="k">def</span> <span class="nf">limitx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_limit_gui</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limity"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limity">[docs]</a>    <span class="k">def</span> <span class="nf">limity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_limit_gui</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limitz"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limitz">[docs]</a>    <span class="k">def</span> <span class="nf">limitz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_limit_gui</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.viewyz"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.viewyz">[docs]</a>    <span class="k">def</span> <span class="nf">viewyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change camera position to yz plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setCameraPosition</span><span class="p">(</span><span class="n">elevation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.viewyz_left"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.viewyz_left">[docs]</a>    <span class="k">def</span> <span class="nf">viewyz_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change camera position to yz plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setCameraPosition</span><span class="p">(</span><span class="n">elevation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.viewxz"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.viewxz">[docs]</a>    <span class="k">def</span> <span class="nf">viewxz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change camera position to xz plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setCameraPosition</span><span class="p">(</span><span class="n">elevation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.viewxy"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.viewxy">[docs]</a>    <span class="k">def</span> <span class="nf">viewxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change camera position to xy plane.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setCameraPosition</span><span class="p">(</span><span class="n">elevation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.set_limit_gui"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.set_limit_gui">[docs]</a>    <span class="k">def</span> <span class="nf">set_limit_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_nsteps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_start_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Slider Start Pos : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_start_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Slider Start Pos : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_start_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_start_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_nsteps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_stop_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Slider Stop Pos : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_stop_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Slider Stop Pos : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_stop_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_stop_pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.limit_start_scroll"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_start_scroll">[docs]</a>    <span class="k">def</span> <span class="nf">limit_start_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is called if the scroll bar self.limit_start_sb is moved.</span>

<span class="sd">        It puts the (new) current value of the scroll bar in self._limit_start, matches</span>
<span class="sd">        the line text in self.limit_start_le and calls neurons_set() which takes care of further updating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_sb</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limit_stop_scroll"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_stop_scroll">[docs]</a>    <span class="k">def</span> <span class="nf">limit_stop_scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is called if the scroll bar self.limit_stop_sb is moved.</span>

<span class="sd">        It puts the (new) current value of the scroll bar in self._limit_stop, matches</span>
<span class="sd">        the line text in self.limit_stop_le and calls neurons_set() which takes care of further updating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_sb</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_slider_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limit_start"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_start">[docs]</a>    <span class="k">def</span> <span class="nf">limit_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is called if the line edit self.limit_start_le has been edited.</span>

<span class="sd">        It puts the (new) current value of the line text in self._limit_start and</span>
<span class="sd">        calls neurons_set() which takes care of further updating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">isModified</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_start_le</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.limit_stop"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.limit_stop">[docs]</a>    <span class="k">def</span> <span class="nf">limit_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function is called if the line edit self.limit_stop_le has been edited.</span>

<span class="sd">        It puts the (new) current value of the line text in self._limit_stop and</span>
<span class="sd">        calls neurons_set() which takes care of further updating.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">isModified</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimsel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_stop_le</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.plot_time_changed"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.plot_time_changed">[docs]</a>    <span class="k">def</span> <span class="nf">plot_time_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function updates self.current_time if the time in one of the plots</span>
<span class="sd">        has been changed by the user.</span>

<span class="sd">        Parameter:</span>
<span class="sd">        ----------</span>
<span class="sd">            marker: pg.InfiniteLine class</span>
<span class="sd">                The vertical time line in the plots are of this instance.</span>
<span class="sd">                Their attribute .value() is called to get the new time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">marker</span><span class="o">.</span><span class="n">value</span><span class="p">())</span></div>

<div class="viewcode-block" id="Fishualizer.neurons_set"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.neurons_set">[docs]</a>    <span class="k">def</span> <span class="nf">neurons_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This functions selects the neurons currently visible with the xyz limit bars</span>
<span class="sd">        and hides the others.</span>

<span class="sd">        It loops through the three dimensions xyz and finds all coords that are</span>
<span class="sd">        between the self._limit_start and self._limit_stop. Subsequently self._selected_inds</span>
<span class="sd">        is updated and update_plot() is called, which only plots neurons in self._selected_inds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="c1"># Hack to get a boolean variable of matches shape</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">remain_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cInd</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="n">scaled_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[:,</span> <span class="n">cInd</span><span class="p">]</span>
                <span class="n">scaling_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span>
                <span class="n">inv_scaling_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">scaling_factor</span><span class="p">[</span><span class="n">cInd</span><span class="p">]</span>  <span class="c1"># scale back to raw coordinates (to avoid sign changes which could be confusing)</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="n">inv_scaling_factor</span> <span class="o">*</span> <span class="n">scaled_coord</span>
                <span class="n">coord_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">coord</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_start</span><span class="p">[</span><span class="n">cInd</span><span class="p">],</span> <span class="n">coord</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_stop</span><span class="p">[</span><span class="n">cInd</span><span class="p">])</span>
                <span class="n">remain_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">remain_ind</span><span class="p">,</span> <span class="n">coord_ind</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">remain_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labelled_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labelled_inds</span><span class="p">)</span>

            <span class="c1"># print(&#39;Number of Selected Neurons : {}&#39;.format(self._selected_inds[0].shape[0]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selection_updated</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.select_cell"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.select_cell">[docs]</a>    <span class="k">def</span> <span class="nf">select_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_click</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visually select a neuron based on the camera position and the mouse click position.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            pos_click:</span>
<span class="sd">                clicked mouse position</span>
<span class="sd">            alt: 0 or 1</span>
<span class="sd">                Whether alt is pressed, to know whether to move the alt=0 or alt=1 selection ball</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="c1"># get center of current view</span>
            <span class="n">centerQT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centerQT</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">centerQT</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">centerQT</span><span class="o">.</span><span class="n">z</span><span class="p">()])</span>

            <span class="c1"># get vector to camera</span>
            <span class="n">vectorQT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">cameraPosition</span><span class="p">()</span>
            <span class="n">vector_camera</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vectorQT</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">vectorQT</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">vectorQT</span><span class="o">.</span><span class="n">z</span><span class="p">()])</span>

            <span class="c1"># relate points and camera vector to camera position</span>
            <span class="n">coords_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">]</span> <span class="o">-</span> <span class="n">vector_camera</span>
            <span class="n">vector_center</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">vector_camera</span>

            <span class="k">if</span> <span class="n">pos_click</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># for mouse click on, find the deviation of the</span>
                <span class="n">fov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;fov&#39;</span><span class="p">]</span>  <span class="c1"># field of view in degrees</span>
                <span class="n">viewsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>  <span class="c1"># size of the display in pixels</span>

                <span class="n">deg_per_pixel</span> <span class="o">=</span> <span class="n">fov</span> <span class="o">/</span> <span class="n">viewsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">deg_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos_click</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">-</span> <span class="n">viewsize</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">deg_per_pixel</span> <span class="o">*</span> <span class="p">(</span><span class="n">pos_click</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">viewsize</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

                <span class="c1"># rotate a vector in the default coordinate system accordingly</span>
                <span class="n">rotated_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">]</span>

                <span class="c1"># apply this vector to the cameras coordinate system</span>
                <span class="n">BV0</span> <span class="o">=</span> <span class="p">[</span><span class="n">vector_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">vector_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">BV0</span> <span class="o">=</span> <span class="n">BV0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">BV0</span><span class="p">)</span>
                <span class="n">BV2</span> <span class="o">=</span> <span class="n">vector_center</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector_center</span><span class="p">)</span>
                <span class="n">BV1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">BV0</span><span class="p">,</span> <span class="n">BV2</span><span class="p">)</span>
                <span class="n">BV1</span> <span class="o">=</span> <span class="n">BV1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">BV1</span><span class="p">)</span>
                <span class="n">vector_target</span> <span class="o">=</span> <span class="n">rotated_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">BV0</span> <span class="o">+</span> <span class="n">rotated_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">BV1</span> <span class="o">+</span> <span class="n">rotated_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">BV2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vector_target</span> <span class="o">=</span> <span class="n">vector_center</span>

            <span class="c1"># Project the coordinates onto the view axis and find closest point in the orthogonal direction</span>
            <span class="n">scalar_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coords_centered</span><span class="p">,</span> <span class="n">vector_target</span><span class="p">)</span>  <span class="c1"># Nx1</span>
            <span class="n">scalar_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">scalar_proj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector_target</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector_target</span><span class="p">))</span>
            <span class="n">aligned_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vector_target</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">scalar_proj</span><span class="p">))</span>
            <span class="n">orthogonal_vectors</span> <span class="o">=</span> <span class="n">coords_centered</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">aligned_vectors</span><span class="p">)</span>  <span class="c1"># 3xN</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">orthogonal_vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># compute weights based on current distribution of values. Weights are supposed to aid the selection, but preferring relatively large activities</span>
            <span class="n">current_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">current_intensities</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">distances</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># consider only weights within 10 microns</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">distances</span><span class="p">))</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span> <span class="o">=</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_cell</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.show_cell"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.show_cell">[docs]</a>    <span class="k">def</span> <span class="nf">show_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show white ball around selected cell and plot its trace</span>

<span class="sd">        Parameters:</span>
<span class="sd">            index: int, default=-1</span>
<span class="sd">                cell index</span>
<span class="sd">            alt, 0 or 1, default=0</span>
<span class="sd">                parameter indicating whether the alt=0 or alt=1 cell is considered</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_cell_dialog</span><span class="o">.</span><span class="n">cellnumber</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span> <span class="o">=</span> <span class="n">index</span>

        <span class="c1"># Indicate the selected neuron, by moving the selector onto it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_3D</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Selected Neuron : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected Neuron : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span>
        <span class="c1"># in case the connections are displayed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.recompute_backdrops"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.recompute_backdrops">[docs]</a>    <span class="k">def</span> <span class="nf">recompute_backdrops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute common backdrops, like average activity, additional ones can be loaded from outside analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.backdrops[&#39;average&#39;] = np.mean(self._data[&#39;values&#39;])</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Fishualizer.resize_scrollbar"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.resize_scrollbar">[docs]</a>    <span class="k">def</span> <span class="nf">resize_scrollbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resize the scroll bar according to the number of time points the data have</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="Fishualizer.frame_to_array"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.frame_to_array">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">frame_to_array</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
        <span class="n">frame_bits</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">bits</span><span class="p">()</span>
        <span class="n">str_frame</span> <span class="o">=</span> <span class="n">frame_bits</span><span class="o">.</span><span class="n">asstring</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">*</span> <span class="n">frame</span><span class="o">.</span><span class="n">depth</span><span class="p">()</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">frame_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">str_frame</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span> <span class="n">frame</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">frame</span><span class="o">.</span><span class="n">depth</span><span class="p">()</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">frame_arr</span> <span class="o">=</span> <span class="n">frame_arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">frame_arr</span></div>

<div class="viewcode-block" id="Fishualizer.grab_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.grab_plot">[docs]</a>    <span class="k">def</span> <span class="nf">grab_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a screenshot of self.view3D and save via QFileDialog.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">grabFrameBuffer</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">convertToFormat</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGB32</span><span class="p">)</span>
        <span class="n">frame_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_to_array</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">im_path</span><span class="p">,</span> <span class="n">_filter</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Saving figure to...&quot;</span><span class="p">,</span>
                                                                    <span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;Image (*.png)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">im_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
                <span class="n">im_path</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>
            <span class="n">imwrite</span><span class="p">(</span><span class="n">im_path</span><span class="p">,</span> <span class="n">frame_arr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.video_export"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.video_export">[docs]</a>    <span class="k">def</span> <span class="nf">video_export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">video_path</span><span class="p">,</span> <span class="n">_filter</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Saving video to...&quot;</span><span class="p">,</span>
                                                                        <span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;Video (*.mp4 )&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">video_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="c1"># Saving</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">video_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mp4&#39;</span><span class="p">):</span>
                    <span class="n">video_path</span> <span class="o">+=</span> <span class="s1">&#39;.mp4&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_writer</span> <span class="o">=</span> <span class="n">get_writer</span><span class="p">(</span><span class="n">video_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">video_action</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.video_recording"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.video_recording">[docs]</a>    <span class="k">def</span> <span class="nf">video_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save frame in video_writer.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">grabFrameBuffer</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">convertToFormat</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGB32</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">scaledToWidth</span><span class="p">(</span><span class="mi">1080</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1080</span><span class="p">,</span> <span class="mi">720</span><span class="p">)</span>
        <span class="n">frame_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_to_array</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_writer</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">frame_arr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.play"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.play">[docs]</a>    <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback handling the play button, to pley the movie</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Event can be none if triggered through the keyboard shorcut</span>
        <span class="c1"># In that case we click the button and then check its state to know if we start or stop the animation</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
            <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">play_btn</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
            <span class="c1"># Starting to play by starting the Timer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c_pbc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Stopping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.switch_rotation"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.switch_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">switch_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Toggle rotation during play animation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_on_play</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_on_play</span></div>

<div class="viewcode-block" id="Fishualizer.set_labelled"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.set_labelled">[docs]</a>    <span class="k">def</span> <span class="nf">set_labelled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labelled_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelled_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neurons_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.animate"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.animate">[docs]</a>    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function called by the animation Timer</span>
<span class="sd">        Dependent on the setting self.animate_mode either a normal rotation is</span>
<span class="sd">        performed (self.animate_mode==&#39;default&#39; and if self._rotate_on_play==1) or</span>
<span class="sd">        a preprogrammed (in this function) camera trajectory is executed (self.animate_mode==&#39;fancy_movie&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">animate_mode</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_on_play</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># azimuth rotation only</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">orbit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_animate_azimuth_step</span><span class="p">)</span>  <span class="c1"># increase azimuth</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">animate_mode</span> <span class="o">==</span> <span class="s1">&#39;fancy_movie&#39;</span><span class="p">:</span>  <span class="c1"># customize movement</span>
            <span class="n">magnification</span> <span class="o">=</span> <span class="mf">0.98</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&lt;=</span> <span class="mi">160</span><span class="p">):</span>  <span class="c1"># decrease elevation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">orbit</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&lt;=</span> <span class="mi">225</span><span class="p">):</span>  <span class="c1"># zoom in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnification</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&lt;=</span> <span class="mi">360</span><span class="p">):</span>  <span class="c1"># increase elevation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">orbit</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&lt;=</span> <span class="mi">425</span><span class="p">):</span>  <span class="c1"># zoom out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">magnification</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Increment the current frame number, the setter take care of the rest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset current frame once we reach the end</span>
        <span class="c1"># pbc = &#39;-\|/&#39;</span>
        <span class="n">pbc</span> <span class="o">=</span> <span class="s1">&#39;               &gt;&lt;(((°&gt; &#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_pbc</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_pbc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Playing </span><span class="si">{pbc[-self.c_pbc:]}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.selection_change"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.selection_change">[docs]</a>    <span class="k">def</span> <span class="nf">selection_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback method for the combobox allowing to select the displayed data</span>
<span class="sd">        It can also be used programmatically to reset the selection</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection: int or str</span>
<span class="sd">            Either the index or the name of the data set to select</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># evoked through code</span>
            <span class="n">data_set</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># evoked through GUI</span>
            <span class="n">data_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_set</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">=</span> <span class="n">data_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;df&#39;</span><span class="p">:</span>
            <span class="c1"># self.disp_start[data_set] = 1.1 # NB: this would override the settings in load_data() !</span>
            <span class="c1"># self.disp_stop[data_set] = 1.5  # change default start color for visibility</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.6</span>  <span class="c1"># change default alpha, not as important as start_color, but a little</span>
        <span class="k">elif</span> <span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;spikes&#39;</span><span class="p">:</span>
            <span class="c1"># self.disp_start[data_set] = 0</span>
            <span class="c1"># self.disp_stop[data_set] = 0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Static data sets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_sb</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span>

        <span class="c1"># Update color limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="n">data_set</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">data_set</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.selection_toggle"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.selection_toggle">[docs]</a>    <span class="k">def</span> <span class="nf">selection_toggle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_selection</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.export_selected"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.export_selected">[docs]</a>    <span class="k">def</span> <span class="nf">export_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the data corresponding the current selection to .npz file&quot;&quot;&quot;</span>
        <span class="n">c_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span>
        <span class="n">c_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">c_ind</span><span class="p">]</span>  <span class="c1">#TODO: Should we change this to current data set (self.data_set)?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exporting Cell Numbers and Calcium Data to ExportSelectedData.npz&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exporting Cell Numbers and Calcium Data to ExportSelectedData.npz&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;ExportSelectedData.npz&#39;</span><span class="p">,</span> <span class="n">c_ind</span><span class="p">,</span> <span class="n">c_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;Exported Cell Numbers and Calcium Data to ExportSelectedData.npz&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.leaving"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.leaving">[docs]</a>    <span class="k">def</span> <span class="nf">leaving</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the Fishualizer is closed, call Viewer.leaving() to close the kernel</span>
<span class="sd">        and then stop video exporting if still recording&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">leaving</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_video</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span>

    <span class="nd">@data_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the data path changes, open the corresponding data file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value: str</span>
<span class="sd">            Path to the data as selected from the dialog box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span>

    <span class="nd">@rec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_times</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nb_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nb_times</span>

    <span class="nd">@nb_times</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nb_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the number of time points in the data changes, resize the scrollbar accordingly</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value: int</span>
<span class="sd">            Number of time points in the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nb_times</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize_scrollbar</span><span class="p">()</span>

<div class="viewcode-block" id="Fishualizer.get_current_values"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.get_current_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the values of all neurons of the current data set and frame</span>

<span class="sd">        Returns:</span>
<span class="sd">        ---------</span>
<span class="sd">            current_values: np.array</span>
<span class="sd">                The numerical values of the current data set and current frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;df&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;spikes&#39;</span><span class="p">:</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">])</span>  <span class="c1"># Select relevant data</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
                <span class="n">tmp</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inds</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">output</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span><span class="p">])</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_cells</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Number of Connections {len(inds)}&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_values</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>  <span class="c1"># Assign connection values for estimated subset (spiking)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_values</span></div>

<div class="viewcode-block" id="Fishualizer.update_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.update_plot">[docs]</a>    <span class="k">def</span> <span class="nf">update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the plot, this function is called if something in the data has changed</span>
<span class="sd">        (e.g. different frame or different data set)</span>

<span class="sd">        This function clips the current values to the interval [self.disp_start,</span>
<span class="sd">        self.disp_stop]. Values are mapped to colors via self.cmap. If no instance</span>
<span class="sd">        exists in self.Plot3D, initialization features are created (e.g. camera position,</span>
<span class="sd">        GLScatterPlotItem, reference axes).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="c1"># DATA SELECTION</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_values</span><span class="p">()</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotopts</span><span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">]:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span>
                <span class="n">c_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setX</span><span class="p">(</span><span class="n">c_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="n">c_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setZ</span><span class="p">(</span><span class="n">c_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

            <span class="c1"># COLORMAPPING</span>
            <span class="c1"># Colors have to be float in [0, 1] for GLScatterPlotItem</span>
            <span class="c1"># Scale the displayed values to [0,1] for color mapping</span>
            <span class="n">disp_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span>
            <span class="n">disp_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span>
            <span class="c1"># TODO: Check because can get a RuntimeWarning: invalid value encountered in true_divide</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">current_values</span><span class="p">,</span> <span class="n">disp_start</span><span class="p">,</span> <span class="n">disp_stop</span><span class="p">)</span>
            <span class="n">current_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_values</span> <span class="o">-</span> <span class="n">disp_start</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">disp_stop</span> <span class="o">-</span> <span class="n">disp_start</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_values</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span>  <span class="c1"># update color scale bar</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_plot</span><span class="p">()</span>  <span class="c1"># update behavior plot, because scaling can be off after zoom or new data addition</span>
            <span class="c1"># If no 3D plot ever created, make one and plot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_updated</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLScatterPlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span>
                                                       <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">(</span><span class="s1">&#39;additive&#39;</span><span class="p">)</span>  <span class="c1"># T: I would default to additive, as it is more intuitive when first opening a 60k+ cells data set?</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">setCameraPosition</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_system</span><span class="p">()</span>

                    <span class="n">ref_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">select_3D</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLScatterPlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">ref_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_3D</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_selection_updated</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reuse previous plot, just change the data (positions and/or colors)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.pan_left"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.pan_left">[docs]</a>    <span class="k">def</span> <span class="nf">pan_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pan leftwards.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">pan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">panstep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.pan_right"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.pan_right">[docs]</a>    <span class="k">def</span> <span class="nf">pan_right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pan rightwards.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">pan</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">panstep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.pan_front"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.pan_front">[docs]</a>    <span class="k">def</span> <span class="nf">pan_front</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pan forwards.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">pan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">panstep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.pan_back"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.pan_back">[docs]</a>    <span class="k">def</span> <span class="nf">pan_back</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pan backwards.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">pan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">panstep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.center_view"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.center_view">[docs]</a>    <span class="k">def</span> <span class="nf">center_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the center of the view to the origin.&quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setX</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setZ</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.change_playtimer_interval"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.change_playtimer_interval">[docs]</a>    <span class="k">def</span> <span class="nf">change_playtimer_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the frame rate of the playtimer. This functions prompts a</span>
<span class="sd">        QtInputDialog whose output sets the new frame rate.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="n">frequency</span><span class="p">,</span> <span class="n">ok_pressed</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="o">.</span><span class="n">getDouble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Playing speed&quot;</span><span class="p">,</span>
                                                                     <span class="s2">&quot;Please choose a new frame rate (Hz) for the dynamic activity&quot;</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok_pressed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">frequency</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_playtimer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">((</span><span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_rate</span><span class="p">))</span>  <span class="c1"># convert to interval in ms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Frame rate changed to </span><span class="si">{frequency}</span><span class="s1"> Hz&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Frame rate changed to </span><span class="si">{frequency}</span><span class="s1"> Hz&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.regions_add"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.regions_add">[docs]</a>    <span class="k">def</span> <span class="nf">regions_add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add region names to qcombobox in the GUI.</span>

<span class="sd">        This function is called by load_data() if labels are availabel in self.rec&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_indices</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Add the set of all regions at the beginning to the dropdown</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_cells</span>  <span class="c1"># data[&#39;df&#39;].shape[0]</span>
        <span class="n">c_string</span> <span class="o">=</span> <span class="s1">&#39;All Main Divisions&#39;</span> <span class="o">+</span> <span class="s1">&#39; (N=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">c_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_zbrain_divisions</span>
        <span class="c1"># Add all other regions to the dropdown</span>
        <span class="k">for</span> <span class="n">i_pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">)):</span>
            <span class="n">c_cell_inds</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">[:,</span> <span class="n">i_pos</span><span class="p">])</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="n">c_cell_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">c_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">[</span><span class="n">i_pos</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (N=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">c_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_indices</span><span class="p">[</span><span class="n">i_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i_pos</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;AllMainDivisions&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.draw_hull"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_hull">[docs]</a>    <span class="k">def</span> <span class="nf">draw_hull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">iH</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw a region hull.</span>

<span class="sd">        This function is called by region_change().</span>
<span class="sd">        Separate all neurons in two groups by kmeans. (For disjoint regions like habenula).</span>
<span class="sd">        Split z coords in max 100 bin, compute convex hull per bin. Then create the</span>
<span class="sd">        Delaunay triangulation of all neurons in the all convex hulls. Add this as</span>
<span class="sd">        a GLMeshItem to self.hulls, which in turn is added to self.view3D</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">            coords: np.array [n, 3]</span>
<span class="sd">                coordinates of all neurons inside the region.</span>
<span class="sd">            iH: int</span>
<span class="sd">                index of current hull. If multiple regions are drawn then iH</span>
<span class="sd">                keeps track of which region that is.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">vq</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">book</span><span class="p">)</span>
            <span class="n">zs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">hull_points</span> <span class="o">=</span> <span class="p">{</span><span class="n">cl</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># for max 100 horizontal z-stacks</span>
                <span class="n">horizontal_alignment</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># z-stacks not horizontally aligned (and thus many zs values)</span>
                <span class="n">horizontal_alignment</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">n_intervals</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># number of new z planes to evaluate</span>
                <span class="n">min_zs</span><span class="p">,</span> <span class="n">max_zs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
                <span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_zs</span><span class="p">,</span> <span class="n">max_zs</span><span class="p">,</span> <span class="n">n_intervals</span><span class="p">)</span>  <span class="c1"># create linear array of zs values</span>
                <span class="n">stepsize_zs</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">zs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">c_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">code</span> <span class="o">==</span> <span class="n">cl</span><span class="p">]</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    ## This commented section defines a hard-coded midline cut</span>
<span class="sd">                    # of the Mes. and Tel. if all main divisions are plotted. Caveat:</span>
<span class="sd">                    # only works in zbrain coordintes (because of hard coded midline coords).!</span>
<span class="sd">                    if iH == 4 or iH == 1:</span>
<span class="sd">                        if iH == 1:</span>
<span class="sd">                            self._logger.debug(&#39;Mesencephalic midline cut&#39;)</span>
<span class="sd">                        if iH == 4:</span>
<span class="sd">                            self._logger.debug(&#39;Telencephalic midline cut&#39;)</span>
<span class="sd">                        if cl == 0:</span>
<span class="sd">                            c_coords = coords[np.where(coords[:, 0] &lt;= 0.248)[0], :]</span>
<span class="sd">                        elif cl == 1:</span>
<span class="sd">                            c_coords = coords[np.where(coords[:, 0] &gt; 0.248)[0], :]</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">if</span> <span class="n">horizontal_alignment</span><span class="p">:</span>
                        <span class="n">c_slice</span> <span class="o">=</span> <span class="n">c_coords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">c_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">),</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># change absolute tolerance(=stepsize_zs) to include all neurons in z-vicinity</span>
                        <span class="n">c_slice</span> <span class="o">=</span> <span class="n">c_coords</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">c_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">stepsize_zs</span><span class="p">),</span> <span class="p">:]</span>
                    <span class="k">if</span> <span class="n">c_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">hull_points</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">hull_points</span><span class="p">[</span><span class="n">cl</span><span class="p">],</span> <span class="n">c_slice</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">c_slice</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">hull_points</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">hull_points</span><span class="p">[</span><span class="n">cl</span><span class="p">],</span> <span class="n">c_slice</span><span class="p">[</span><span class="n">hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">c_coords</span> <span class="o">=</span> <span class="n">hull_points</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">c_coords</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span>
                <span class="c1"># if self.hulls[cl] is None:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLMeshItem</span><span class="p">(</span><span class="n">vertexes</span><span class="o">=</span><span class="n">c_coords</span><span class="p">,</span> <span class="n">faces</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">convex_hull</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="n">drawEdges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drawFaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">setGLOptions</span><span class="p">(</span><span class="s1">&#39;additive&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">cl</span><span class="p">])</span>

        <span class="k">except</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">qhull</span><span class="o">.</span><span class="n">QhullError</span><span class="p">:</span>  <span class="c1"># this error can otherwise crash the app</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;QHull error while computing hulls&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;QHull error while computing hulls&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.region_change"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.region_change">[docs]</a>    <span class="k">def</span> <span class="nf">region_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare a new region draw of the currently selected region.</span>

<span class="sd">        This function is called if the region combobox is changed, or by other functions</span>
<span class="sd">        if a new region needs to be drawn.</span>
<span class="sd">        This function removes previous hulls and selects coordinates to be used.</span>
<span class="sd">        Then draw_hull() is called for the new region draw.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">c_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">c_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># reset</span>
            <span class="n">region_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_indices</span><span class="p">[</span><span class="n">c_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">iL</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">iL</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">iL</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">region_indices</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">region_indices</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">c_region_index</span> <span class="o">=</span> <span class="n">region_indices</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span>
                <span class="n">c_cell_inds</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">[:,</span> <span class="n">c_region_index</span><span class="p">])</span>
                <span class="n">c_cell_inds</span> <span class="o">=</span> <span class="n">c_cell_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">c_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">[</span><span class="n">c_cell_inds</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span><span class="p">:</span>
                    <span class="n">grid_unit_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">zbrainatlas_regions</span> <span class="o">==</span> <span class="n">c_region_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">c_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">zbrainatlas_coordinates</span><span class="p">[</span><span class="n">grid_unit_inds</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Drawing index: </span><span class="si">{c_region_index}</span><span class="s1"> and name: </span><span class="si">{self.labelnames[c_region_index + 1]}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Drawing index: </span><span class="si">{}</span><span class="s1"> and name: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_region_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">[</span><span class="n">c_region_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">c_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_hull</span><span class="p">(</span><span class="n">c_coordinates</span><span class="p">,</span> <span class="n">iH</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No Neurons assigned to this region.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="s1">&#39;No Neurons assigned to this region.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Neurons assigned to this region.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.region_show"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.region_show">[docs]</a>    <span class="k">def</span> <span class="nf">region_show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable region hulls if region chechbox is checked.</span>

<span class="sd">        Set visibility of the different regions. Call self.region_change() to draw the hull</span>
<span class="sd">        unless self.hulls exist (when region is unchanged but region_check_cb has been unchecked/checked).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_hull</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull_color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Current Color: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current Color: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span><span class="p">))</span> <span class="c1">#only print if checked True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">iL</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="c1"># self.hulls[iH][iL].setMeshData(faceColors=self.current_hull_color)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hulls</span><span class="p">[</span><span class="n">iH</span><span class="p">][</span><span class="n">iL</span><span class="p">]</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;meshdata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setFaceColors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_hull_color</span><span class="p">)</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_hull</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_change</span><span class="p">()</span></div>
        <span class="c1">#self.update_plot()  # not needed here, and interfers with draw_clusters() because the plot changes</span>

<div class="viewcode-block" id="Fishualizer.add_static_gui"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_static_gui">[docs]</a>    <span class="k">def</span> <span class="nf">add_static_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call UI to add static data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static_data_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># main data is not loaded, this would a error later (self.data not defined, no coordinates etc.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Please load main data file first before adding static data sets&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.compute_correlation_gui"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.compute_correlation_gui">[docs]</a>    <span class="k">def</span> <span class="nf">compute_correlation_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call UI to compute correlation w.r.t. stimulus or behavior.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">single_data</span><span class="p">:</span>  <span class="c1"># option 1 - available single time traces as defined in Zecording</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_single</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_single</span><span class="o">.</span><span class="n">count</span><span class="p">())]:</span>  <span class="c1"># if not already in QComboBox, alternatively one could reset all QComboVox options</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_single</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">multi_data</span><span class="p">:</span>  <span class="c1"># option 2 - available multi time traces a defined in Zecording</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_multi</span><span class="o">.</span><span class="n">itemText</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                 <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_multi</span><span class="o">.</span><span class="n">count</span><span class="p">())]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_multi</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># call dialog</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># main data is not loaded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Please load main data file first before computing correlations&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.compute_correlation_function"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.compute_correlation_function">[docs]</a>    <span class="k">def</span> <span class="nf">compute_correlation_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute correlation between single time trace data and multi time traces data.</span>

<span class="sd">        Uses current settings of QComboBoxes in compute_correlation_dialog to fetch data sets</span>
<span class="sd">        Adds correlation to static data sets and add to self.rec via add_static()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_single</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_single</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>  <span class="c1"># get current selections</span>
        <span class="n">name_multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_correlation_dialog</span><span class="o">.</span><span class="n">correlation_multi</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">kwargs_fun</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sig_1D&#39;</span><span class="p">:</span> <span class="n">name_single</span><span class="p">,</span> <span class="s1">&#39;sigs_2D&#39;</span><span class="p">:</span> <span class="n">name_multi</span><span class="p">}</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">name_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">compute_analysis</span><span class="p">(</span><span class="n">correlation_1D2D</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_fun</span><span class="p">)</span>
        <span class="n">name_result</span> <span class="o">=</span> <span class="n">name_result</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name_single</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">name_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.select_file_and_load"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.select_file_and_load">[docs]</a>    <span class="k">def</span> <span class="nf">select_file_and_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;static&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;UI to load datasets by browsing through directories.</span>

<span class="sd">        Parameter:</span>
<span class="sd">        -----------</span>
<span class="sd">            - option, str, optional</span>
<span class="sd">                if &#39;connection&#39; a sparse connectivity matrix is loaded</span>
<span class="sd">                else a single static data set must be added.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -----------</span>
<span class="sd">            c_data: multiple types possible (dependent on file type)</span>
<span class="sd">                loaded data set</span>
<span class="sd">            import_data_method: str, is defined in this function</span>
<span class="sd">                Because multiple data types can be returned, this parameter gives</span>
<span class="sd">                &#39;instructions&#39; how to handle the data to the function calling select_file_and_load()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># .npy &amp; .npz: single datasets, .h5: pd matrix of multiple sets.</span>
        <span class="c1"># cwd = os.getcwd()</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;static_path&#39;</span><span class="p">]</span>
        <span class="n">dpath</span><span class="p">,</span> <span class="n">_filter</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Choose a data file&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span>
                                                               <span class="s1">&#39;Data (*.npy *.npz *.h5)&#39;</span><span class="p">)</span>  <span class="c1"># get datapath, like main open_data etc.</span>

        <span class="k">if</span> <span class="n">dpath</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Set the new data path.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span> <span class="o">=</span> <span class="n">dpath</span>  <span class="c1"># do not set self.data_path, because that function opens load_data() at the moment. I think we should avoid altering that sequence (for now)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;static_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>  <span class="c1"># Save it for next time</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Get the extension</span>
        <span class="c1">#  load the data according to the method related to the extension</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;connection&#39;</span><span class="p">:</span>
            <span class="c1">#TODO: hard require that now only a .npz file can be loaded? Move the UI getOpenFileName inside if statement?</span>
            <span class="n">c_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">)</span>
            <span class="n">import_data_method</span> <span class="o">=</span> <span class="s1">&#39;connectivity&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.npy&#39;</span><span class="p">:</span>  <span class="c1"># load regular files</span>
                    <span class="n">c_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">))</span>  <span class="c1"># add file to self.data dictionary</span>
                    <span class="n">import_data_method</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
                <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.npz&#39;</span><span class="p">:</span>  <span class="c1"># load sparse files, squeeze to ensure proper shape</span>
                    <span class="n">c_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">load_npz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">)</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
                    <span class="n">import_data_method</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
                <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.h5&#39;</span><span class="p">:</span>  <span class="c1"># load pd matrix</span>
                    <span class="n">c_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">)</span>
                    <span class="n">import_data_method</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Invalid static data file </span><span class="si">{dpath}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># if some invalid file is added, it crashes when the option is data in the dropdown menu (KeyError)</span>
                <span class="k">return</span>

        <span class="k">return</span> <span class="n">c_data</span><span class="p">,</span> <span class="n">import_data_method</span></div>

<div class="viewcode-block" id="Fishualizer.load_static"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.load_static">[docs]</a>    <span class="k">def</span> <span class="nf">load_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load static data set by calling UI function to select and call add_static() to add.&quot;&quot;&quot;</span>
        <span class="n">c_data</span><span class="p">,</span> <span class="n">import_data_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_file_and_load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">import_data_method</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="n">dataname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_data_dialog</span><span class="o">.</span><span class="n">load_dataname</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">c_data</span><span class="p">,</span> <span class="n">dataname</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">import_data_method</span> <span class="o">==</span> <span class="s1">&#39;multi&#39;</span><span class="p">:</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>  <span class="c1"># get column names</span>
            <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="p">)</span>
            <span class="n">ind_neurons</span> <span class="o">=</span> <span class="n">c_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># indices of neurons in df</span>
            <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>  <span class="c1"># loop through columns</span>
                <span class="c1"># Create new data variables (with column names) in self.data, as np.zeros with column inserted?</span>
                <span class="n">c_data_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)</span>  <span class="c1"># create empty array (not-specificied neuron thus get default-value 0)</span>
                <span class="n">c_data_ind</span><span class="p">[</span><span class="n">ind_neurons</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_data</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>  <span class="c1"># put in values of c_name column</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">c_data_ind</span><span class="p">,</span> <span class="n">c_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.add_static"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_static">[docs]</a>    <span class="k">def</span> <span class="nf">add_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_data</span><span class="p">,</span> <span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a static data set to Zecording and set appropriate internal parameters</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        c_data:  # TODO: require this to be of correct dimenions (n_cells x 1)?</span>
<span class="sd">             dataset to add</span>
<span class="sd">        dataname: str</span>
<span class="sd">             dataname to use, # DONE: check if already exists, else alter to avoid overwriting?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{dataname}</span><span class="s1">_</span><span class="si">{suffix}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">previous_suffix_str</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;_{suffix-1}&#39;</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="n">dataname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">previous_suffix_str</span><span class="p">)</span>  <span class="c1"># does not break while loop because dataname must be in</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{dataname}</span><span class="s1">_</span><span class="si">{suffix}</span><span class="s1">&#39;</span>
            <span class="n">start</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">dataname</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">input</span>  <span class="c1"># because they are the same, input is added first in add_connectivity(), better for memory allocation(?)</span>
        <span class="k">elif</span> <span class="n">dataname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="p">,</span> <span class="n">dataname</span><span class="p">,</span> <span class="n">c_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataname</span> <span class="o">==</span> <span class="s1">&#39;output&#39;</span> <span class="ow">or</span> <span class="n">dataname</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataname</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataname</span><span class="p">],</span> <span class="mi">99</span><span class="p">)</span>
        <span class="c1"># if almost all neurons are 0, the 99 percentile also is 0 (and the fish is not drawn)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>  <span class="c1"># add option to dropdown menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increase index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sel_cb</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.compute_static"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.compute_static">[docs]</a>    <span class="k">def</span> <span class="nf">compute_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute static data set based on user input formula.&quot;&quot;&quot;</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_data_dialog</span><span class="o">.</span><span class="n">compute_formula</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">c_data</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;np.apply_along_axis(&#39;</span> <span class="o">+</span> <span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;,1,self.rec.datasets[self.data_set])&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">c_data</span><span class="p">,</span> <span class="n">formula</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.add_connectivity"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">add_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add sparse connectivity matrix to two static data sets (input and output).&quot;&quot;&quot;</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_file_and_load</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">connections</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">connections</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.plot_trace"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.plot_trace">[docs]</a>    <span class="k">def</span> <span class="nf">plot_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot trace of selected neuron in self.activity_pw</span>

<span class="sd">        Calcium trace is deconvolved online, spikes are also plotted.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">            index, optional (default = 0)</span>
<span class="sd">                index of the selected neuron</span>
<span class="sd">            alt, option (default = 0)</span>
<span class="sd">                Different neurons can be plotted simultaneously (currently 2 neurons)</span>
<span class="sd">                the alt parameter tracks which plot is affected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span> <span class="o">=</span> <span class="n">alt</span>

        <span class="n">c_region</span> <span class="o">=</span> <span class="s1">&#39;not assigned&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span><span class="p">:</span>
            <span class="n">c_region_index</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">if</span> <span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">[</span><span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Account for all region</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activity_plots</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="s1">&#39;spikes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span>
                                                                      <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">spikes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;oasis&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>  <span class="c1"># only if oasis module is loaded, spikes can be deconvolved</span>
            <span class="n">single_spike_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_deconvolv</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># deconvolve online (just 1 neuron)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_spikes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span>
                                                                      <span class="n">y</span><span class="o">=</span><span class="n">single_spike_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">single_spike_train</span><span class="p">[</span>
                                                                          <span class="mi">2</span><span class="p">])</span>  <span class="c1"># spike train + individual baseline</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span><span class="p">,</span>
                                                                           <span class="n">y</span><span class="o">=</span><span class="n">single_spike_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">single_spike_train</span><span class="p">[</span>
                                                                               <span class="mi">2</span><span class="p">])</span>  <span class="c1"># calcium fit + individual baseline</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_calcfit</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activity_plot_ind</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># remove remaining plot (from before the toggle)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_text</span><span class="o">.</span><span class="n">setPlainText</span><span class="p">(</span><span class="s1">&#39;Neuron </span><span class="si">{}</span><span class="s1"> (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">c_region</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_neuron_plot_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span>  <span class="c1"># to feed back when calcium fit is toggled on/off</span></div>

<div class="viewcode-block" id="Fishualizer.edit_cmap"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.edit_cmap">[docs]</a>    <span class="k">def</span> <span class="nf">edit_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create UI to choose a colormap.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">edit_cmap</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_r&#39;</span><span class="p">)]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="s1">&#39;Vega&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;spectral&#39;</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="ow">is</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">]</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GFP&#39;</span><span class="p">)</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">ok_pressed</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Choose colormap&quot;</span><span class="p">,</span> <span class="s2">&quot;Name:&quot;</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok_pressed</span> <span class="ow">and</span> <span class="n">item</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mpl_cmap</span> <span class="o">=</span> <span class="n">item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_sel_cp</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.edit_hide"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.edit_hide">[docs]</a>    <span class="k">def</span> <span class="nf">edit_hide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create UI to hide a selection of neurons below or above threshold</span>

<span class="sd">        Plot mean trace of visible neurons in behavior_pw widget</span>

<span class="sd">        Parameter</span>
<span class="sd">        ----------</span>
<span class="sd">            threshold, &#39;min&#39; or &#39;max&#39;:</span>
<span class="sd">                &#39;min&#39; minimum threshold, hide neurons below</span>
<span class="sd">                &#39;max&#39; maximum threshold, hide neurons above</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">edit_hide</span><span class="p">()</span>
        <span class="n">current_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_values</span><span class="p">()</span>
        <span class="n">question_str</span> <span class="o">=</span> <span class="s1">&#39;Choose &#39;</span> <span class="o">+</span> <span class="n">threshold</span> <span class="o">+</span> <span class="s1">&#39;imum threshold value&#39;</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">ok_pressed</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QInputDialog</span><span class="o">.</span><span class="n">getDouble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question_str</span><span class="p">,</span> <span class="s2">&quot;Threshold:&quot;</span><span class="p">,</span>
                                                             <span class="n">current_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok_pressed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">threshold</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_values</span> <span class="o">&gt;</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">threshold</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_values</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selection_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_cells</span><span class="p">:</span>  <span class="c1"># only compute if a subset of all cells is selected (if all cells are selected, it is usually to reset the view, and computing their mean, then a byproduct, takes time)</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">current_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">current_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span>  <span class="c1"># weighted mean of visible cells</span>
                <span class="n">weighted_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">,</span> <span class="p">:])</span>
                <span class="c1"># all_weights = current_values / sum(current_values)  # weighted mean of all cells (including invisible ones)</span>
                <span class="c1"># all_weighted_mean = np.dot(all_weights, self.rec.df)</span>
                <span class="c1"># self.plot_single_df_trace(y_trace=weighted_mean)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_single_df_trace</span><span class="p">(</span><span class="n">y_trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># unweighted mean of visible cells</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.plot_single_df_trace"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.plot_single_df_trace">[docs]</a>    <span class="k">def</span> <span class="nf">plot_single_df_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_trace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot single df/f trace in behavior_pw.</span>

<span class="sd">        This can be any single trace, but with x_trace=self.rec.times (because of the XLink)</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">            - x_trace</span>
<span class="sd">            - y_trace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_trace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotDataItem</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_trace</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_trace</span><span class="p">))</span>  <span class="c1"># plot the mean of the selection</span></div>

<div class="viewcode-block" id="Fishualizer.update_behavior_plot"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.update_behavior_plot">[docs]</a>    <span class="k">def</span> <span class="nf">update_behavior_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the scaling of the self.mean_selection_plot (w.r.t. self.behavior_pw).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stimulus_plot</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">viewRect</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_plot</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">viewRect</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_selection_plot</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_pw</span><span class="o">.</span><span class="n">viewRect</span><span class="p">())</span></div>

<div class="viewcode-block" id="Fishualizer.fast_deconvolv"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.fast_deconvolv">[docs]</a>    <span class="k">def</span> <span class="nf">fast_deconvolv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>  <span class="c1"># calcium_trace = 0): # deconvolve neuron n</span>
        <span class="sd">&quot;&quot;&quot; Use OASIS method to deconolve selected cell online.</span>

<span class="sd">        ----------</span>
<span class="sd">        Parameters:</span>
<span class="sd">        - n: int, index of neuron</span>

<span class="sd">        ---------</span>
<span class="sd">        Returns:</span>
<span class="sd">        - c, calcium fit (from s)</span>
<span class="sd">        - s, inferred spike trace</span>
<span class="sd">        - sig_deconv[2], baseline constant of inference</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ytrace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># get calcium trace</span>
        <span class="n">ytrace</span> <span class="o">=</span> <span class="n">ytrace</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># oasis package only takes float64 as input (in C conversion)</span>
        <span class="c1"># deconvolve for warm start, optimize gamma (= decay time constant)</span>
        <span class="n">sig_deconv</span> <span class="o">=</span> <span class="n">oasis</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">deconvolve</span><span class="p">(</span><span class="n">ytrace</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">optimize_g</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">oasisAR1</span><span class="p">(</span><span class="n">ytrace</span> <span class="o">-</span> <span class="n">sig_deconv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sig_deconv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                        <span class="n">s_min</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># deconvolve again, now set minimal spike height s_min (free parameter!)</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sig_deconv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># return (fitted calcium trace, spike train, baseline)</span></div>

<div class="viewcode-block" id="Fishualizer.toggle_calcium_fit"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.toggle_calcium_fit">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_calcium_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Toggle whether to plot the calcium fit in the neuronal plot.</span>

<span class="sd">        Calcium fit is calculated (together with inferred spike train) by the OASIS method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_calcium_fit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_neuron_plot_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_neuron_plot_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># refresh plot</span></div>

<div class="viewcode-block" id="Fishualizer.show_region_current_cell"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.show_region_current_cell">[docs]</a>    <span class="k">def</span> <span class="nf">show_region_current_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw region of currently selected cell.</span>

<span class="sd">        If regions are loaded and a cell is selected, the hull is drawn</span>
<span class="sd">        of the corresponding cell. Cells usually have multiple reason, the smallest one is drawn.</span>
<span class="sd">        Other regions are printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels_available</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_selected_cell</span>  <span class="c1"># take selected neuron</span>
            <span class="n">c_region_index</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">c_region_print</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_cells_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">iLoop</span><span class="p">,</span> <span class="n">iR</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">c_cell_inds</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">labels</span><span class="p">[:,</span> <span class="n">iR</span><span class="p">])</span>
                    <span class="n">n_cells_region</span><span class="p">[</span><span class="n">iLoop</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_cell_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of cells in this region</span>
                    <span class="n">c_region_print</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelnames</span><span class="p">[</span><span class="n">iR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">iLoop</span><span class="p">,</span> <span class="n">iR</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_region_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">iLoop</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">n_cells_region</span><span class="p">):</span>  <span class="c1"># if smallest region, save index for drawing:</span>
                        <span class="n">i_region_plotted</span> <span class="o">=</span> <span class="n">iR</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Neuron </span><span class="si">{index}</span><span class="s1"> is in region </span><span class="si">{iR}</span><span class="s1">; </span><span class="si">{c_region_print[iR]}</span><span class="s1">, plotted&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># not drawn</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Neuron </span><span class="si">{index}</span><span class="s1"> is in region </span><span class="si">{iR}</span><span class="s1">; </span><span class="si">{c_region_print[iR]}</span><span class="s1">, not plotted&#39;</span><span class="p">)</span>
            <span class="c1"># Currently: show region with smallest N? Toggle this?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># use this region for drawing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_region_selected_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_region_plotted</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># add plus one, because region_change() expects this shift (due to zero-default and dropwown selection)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_sel_cb</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">i_region_plotted</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># add plus for dropdown selection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_change</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.toggle_hideneuropil"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.toggle_hideneuropil">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_hideneuropil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Toggle visibilty of neuropil on or off.</span>

<span class="sd">        Neuropil data is retrieved from self.rec, and should thus be provided in</span>
<span class="sd">        the main hdf5 data file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_neuropil</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_neuropil</span>  <span class="c1"># toggle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;not_neuropil&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_neuropil</span><span class="p">:</span>
                <span class="n">n_neuropil_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">not_neuropil</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">not_neuropil</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Neuropil is not plotted (</span><span class="si">{n_neuropil_cells}</span><span class="s1"> neuropil cells)&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_neuropil</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Neuropil is plotted&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Neuropil information is not loaded in the data&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.swap_color_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.swap_color_axis">[docs]</a>    <span class="k">def</span> <span class="nf">swap_color_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change color axis orientation of current data set (self.data_set).</span>

<span class="sd">        Currently hard-coded: also change the disp_start and disp_stop. This functionality</span>
<span class="sd">        is currently used to view either postive or negative extremes (of e.g.</span>
<span class="sd">        correlations), it saves some scrolling to reset the disp_start and disp_stop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span>  <span class="c1"># swap color axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_color_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">],</span> <span class="mi">99</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_start_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_start</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_color_stop_sb</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disp_stop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">()</span>  <span class="c1"># update the colormap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Fishualizer.add_supplementary_traces"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_supplementary_traces">[docs]</a>    <span class="k">def</span> <span class="nf">add_supplementary_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add some supplementary single traces to the data set.</span>

<span class="sd">        Calling this function adds some pre-defined functions (related to the stimulus) to Zecording class</span>
<span class="sd">        This function can currently only be accessed from the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos_only</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)</span>
        <span class="n">neg_only</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)</span>
        <span class="n">pos_only</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># positive stimulus only</span>
        <span class="n">neg_only</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># negative stimulus only</span>

        <span class="n">supp_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;deriv_stim&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">),</span>
                     <span class="s1">&#39;abs_deriv_stim&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">)),</span>
                     <span class="s1">&#39;pos_only_stim&#39;</span><span class="p">:</span> <span class="n">pos_only</span><span class="p">,</span>
                      <span class="s1">&#39;abs_neg_only_stim&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">neg_only</span><span class="p">)}</span>  <span class="c1"># dictionary of supplementary data to add</span>

        <span class="k">for</span> <span class="n">data_name</span> <span class="ow">in</span> <span class="n">supp_data</span><span class="p">:</span>  <span class="c1"># put all supp. data in rec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="n">s_name</span><span class="o">=</span><span class="n">data_name</span><span class="p">,</span> <span class="n">s_data</span><span class="o">=</span><span class="n">supp_data</span><span class="p">[</span><span class="n">data_name</span><span class="p">])</span>

        <span class="n">pos_deriv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">deriv_stim</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pos_deriv</span><span class="p">[</span><span class="n">pos_deriv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neg_deriv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">deriv_stim</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">neg_deriv</span><span class="p">[</span><span class="n">neg_deriv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;pos_deriv_stim&#39;</span><span class="p">,</span> <span class="n">pos_deriv</span><span class="p">)</span>  <span class="c1"># positive derivative only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;neg_deriv_stim&#39;</span><span class="p">,</span> <span class="n">neg_deriv</span><span class="p">)</span>  <span class="c1"># postiive derivative only</span>

        <span class="k">def</span> <span class="nf">exp_smooth</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">time_constant</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.6</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">)):</span>
            <span class="sd">&quot;&quot;&quot;Exponential smoothing</span>

<span class="sd">            Defined inside add_supplementary_traces()</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">                trace: np.array,</span>
<span class="sd">                    trace to smooth</span>
<span class="sd">                time_constant: float, optional (=2.6 default, GCaMP6s line of Migault et al., submitted)</span>

<span class="sd">            Returns</span>
<span class="sd">            ----------</span>
<span class="sd">                conv_trace:, float</span>
<span class="sd">                    convolved trace</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">alpha_test</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span> <span class="n">time_constant</span><span class="p">))</span> <span class="c1"># exponential decay time constant from Migault et al., 2018, biorxiv paper supp. methods (vestibular)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tau</span><span class="p">:</span> <span class="n">alpha_test</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha_test</span><span class="p">)</span><span class="o">**</span><span class="n">tau</span>
            <span class="n">k_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_len</span><span class="p">),</span> <span class="n">k</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k_len</span><span class="p">))))</span>
            <span class="n">conv_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">conv_trace</span>

        <span class="c1"># Add exponentially smoothed functions. Especially useful for fast derivatives.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;conv_stim&#39;</span><span class="p">,</span> <span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">stimulus</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;conv_pos_stim&#39;</span><span class="p">,</span> <span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">pos_only_stim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;conv_neg_stim&#39;</span><span class="p">,</span> <span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">abs_neg_only_stim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;conv_pos_deriv_stim&#39;</span><span class="p">,</span> <span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">pos_deriv_stim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;conv_neg_deriv_stim&#39;</span><span class="p">,</span> <span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">neg_deriv_stim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;abs_conv_neg_deriv_stim&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">neg_deriv_stim</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">add_supp_single_data</span><span class="p">(</span><span class="s1">&#39;abs_conv_all_deriv_stim&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">exp_smooth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">deriv_stim</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Fishualizer.call_reverse_z_coords"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.call_reverse_z_coords">[docs]</a>    <span class="k">def</span> <span class="nf">call_reverse_z_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to call the Zecording.reverse_z_coords() in self.rec</span>

<span class="sd">        # TODO: swap z legend (Blue one)</span>
<span class="sd">        self.rec.reverse_z_coords() reverses the z coordinates by:</span>
<span class="sd">        z_new = max(z_old) - (z_old - min(z_old))&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">reverse_z_coords</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="Fishualizer.update_coordinate_system"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.update_coordinate_system">[docs]</a>    <span class="k">def</span> <span class="nf">update_coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot coordinate system for reference of front and scale.</span>

<span class="sd">        Parameters (length etc.) are currently hard coded in this function.</span>
<span class="sd">        Coordinate system is created and added to self.view3D</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_x_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_y_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_z_axis</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>  <span class="c1"># if previously initiated, remove axes.</span>

        <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span>
        <span class="n">axis_width</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">ref_length</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">opposite_site_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>  <span class="c1"># used to set coordinate system in opposite quadrant (so that it is not visible in orthogonal views)</span>
        <span class="n">ref_pos</span> <span class="o">=</span> <span class="n">opposite_site_sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[(</span><span class="n">scale_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_length</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">x_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_x_axis</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">x_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">axis_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_x_axis</span><span class="p">)</span>

        <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">scale_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_length</span><span class="p">),</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">y_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_y_axis</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">y_axis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">y_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">axis_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_y_axis</span><span class="p">)</span>

        <span class="n">z_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ref_pos</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">scale_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_length</span><span class="p">)]])</span>
        <span class="n">z_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_z_axis</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">z_axis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">z_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">axis_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_z_axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.scale_coordinates"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.scale_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">scale_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zscale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scale all coordinates in visualization.</span>

<span class="sd">        This function does not overwrite the hdf5 data file. It sets</span>
<span class="sd">        self.rec.coordinate_scale_factor to the given scaling and updates the plot.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            xscale: float</span>
<span class="sd">                new scaling of x coordinates</span>
<span class="sd">            yscale: float</span>
<span class="sd">                new scaling of y coordinates</span>
<span class="sd">            zscale: float</span>
<span class="sd">                new scaling of z coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">zscale</span><span class="p">)</span>  <span class="c1"># set scaler</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">region_change</span><span class="p">()</span>  <span class="c1"># redraw region because scaling factors and thus coordinate plotting has changed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinate_system</span><span class="p">()</span>
            <span class="c1">#TODO save to hdf5 file as attribute (do this inside self.rec.coordinate_scale_factor?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="Fishualizer.inverse_x_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.inverse_x_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_x_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_coordinates</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">yscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.inverse_y_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.inverse_y_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_y_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_coordinates</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yscale</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">zscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.inverse_z_axis"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.inverse_z_axis">[docs]</a>    <span class="k">def</span> <span class="nf">inverse_z_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">coordinate_scale_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_coordinates</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yscale</span><span class="o">=</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zscale</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">current_scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Fishualizer.cluster_color"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.cluster_color">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cl_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;Dataset&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Color&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;Selected&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cl_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">cl_win</span> <span class="o">=</span> <span class="n">ClusterDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">)),</span> <span class="n">data</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_win</span><span class="o">.</span><span class="n">exec_</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_clusters</span><span class="p">(</span><span class="o">**</span><span class="n">cl_win</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.draw_clusters"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_clusters">[docs]</a>    <span class="k">def</span> <span class="nf">draw_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># use **kwargs because unspecified number of clusters</span>
        <span class="sd">&quot;&quot;&quot;Function to color code different clusters in same plot</span>

<span class="sd">        # TODO:</span>
<span class="sd">        Create legend (use dict names)</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            **kwargs: dict containing two-tuples (name, hex_code) as values</span>
<span class="sd">                dict containing {cl_id: (name, hex_code)}</span>
<span class="sd">                    name: str</span>
<span class="sd">                        Should be the name of a single data set available</span>
<span class="sd">                        All nonzero elements are used in cluster plot</span>
<span class="sd">                    hex_code: str or None</span>
<span class="sd">                        Should be hex color code (e.g. &#39;#17becdf&#39;)</span>
<span class="sd">                        Use None if you do not want to specify the color.</span>
<span class="sd">                    alpha: float</span>
<span class="sd">                        Transparency value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_selection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># use set to update sequentially in function</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">n_cells</span><span class="p">),</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cl_id</span><span class="p">,</span> <span class="n">cl_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># data set</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Alpha value: </span><span class="si">{alpha}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if no color is specified</span>
                <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="c1"># create default color cycle</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_cycle</span><span class="p">[</span><span class="n">cl_id</span><span class="p">]</span>
                <span class="c1"># hexcode = color_cycle[cl_id].lstrip(&#39;#&#39;)  # use cl_id-th element of default cycle</span>
            <span class="c1"># else:</span>
            <span class="n">hexcode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">cl_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>  <span class="c1"># use pre-specified color code</span>
            <span class="n">neurons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="p">,</span> <span class="n">name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># find nonzero elements</span>
            <span class="n">current_selection</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">neurons</span><span class="p">))</span>  <span class="c1"># add to selected inds</span>
            <span class="n">color_cl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hexcode</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># transform hex code to float rgb</span>
            <span class="n">color_cl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>  <span class="c1"># add transparency</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">neurons</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color_cl</span><span class="p">)</span>  <span class="c1"># set color for all neurons in cluster</span>

        <span class="c1"># one cannot call update_plot() here because that would override colors, so update explicitly:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl_colors</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current_selection</span><span class="p">))</span>  <span class="c1"># to np array for slicing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_plot</span><span class="p">()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span>  <span class="c1"># only plot self._selected_inds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">(</span><span class="s1">&#39;translucent&#39;</span><span class="p">)</span>  <span class="c1"># set to translucent for better visibility (as long as not too many neurons are plotted)</span></div>
        <span class="c1"># self.hull_color[3] = 0.1</span>
        <span class="c1"># self.current_hull_color = [0.82, 0.82, 0.82, 0]</span>

<div class="viewcode-block" id="Fishualizer.draw_phase_map"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_phase_map">[docs]</a>    <span class="k">def</span> <span class="nf">draw_phase_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amp_thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw a phase map given phase &amp; amplitude data. The phase is colored with</span>
<span class="sd">        the hsv cmap (same as Migault et al. pub), with the brightness scaled with</span>
<span class="sd">        the amplitude.</span>
<span class="sd">        If no phase or amplitude are given as input (i.e. there are None), the function</span>
<span class="sd">        will try to get them from self.rec</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            amp_thresh: float, int</span>
<span class="sd">                amplitude threshold, only points with an amplitude greater than amp_thresh</span>
<span class="sd">                are selected for plotting (self._selected_inds is updated).</span>
<span class="sd">            phase: None or np.array with dims (n_cells,)</span>
<span class="sd">                phases of data.</span>
<span class="sd">            amplitude: None or np.array with dims (n_cells,)</span>
<span class="sd">                amplitudes of data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;phase_map&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">phase_map</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># to ensure color coding is 0 to 2pi</span>
        <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;phase_map&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">phase_map</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase map could not be drawn, because no phase or amplitude was found.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_map</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">hsv</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">color_map</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">/</span> <span class="n">amplitude</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3</span>

            <span class="c1"># colors = colors[:, :3]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">amplitude</span> <span class="o">&gt;</span> <span class="n">amp_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_behavior_plot</span><span class="p">()</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Plot3D</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span><span class="p">])</span>  <span class="c1"># only plot self._selected_inds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switch_alpha_mode</span><span class="p">(</span><span class="s1">&#39;translucent&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.draw_density_map"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_density_map">[docs]</a>    <span class="k">def</span> <span class="nf">draw_density_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maptype</span><span class="o">=</span><span class="s1">&#39;density_map&#39;</span><span class="p">,</span> <span class="n">cut_off_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">density_scale_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add density map to self.view3D, the plot is created via utilities.create_density_map()</span>

<span class="sd">        # TODO: add to add_static_gui ?</span>
<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            datapath: str (default to None)</span>
<span class="sd">                datapath where the density map (in .h5 file) is located. If None,</span>
<span class="sd">                it defaults to hard-coded directory.</span>
<span class="sd">            maptype: str; options: (&#39;density_map&#39;, &#39;hard_threshold&#39;)</span>
<span class="sd">                type of plot</span>
<span class="sd">            cut_off_threshold: float or None</span>
<span class="sd">                threshold for cut-off of density map. If None, it defaults to 0 for map_type == &#39;density_map&#39;</span>
<span class="sd">                and to 0,0005 for map_type == &#39;hard_threshold&#39;</span>
<span class="sd">            density_scale_factor: float, int</span>
<span class="sd">                if maptype == &#39;density_map&#39;, the density is normalized to the max value, and</span>
<span class="sd">                the intensity (alpha) value is subsequently linearly scaled with the normalized</span>
<span class="sd">                density, multiplied by density_scale_factor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">datapath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">datapath</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s1">&#39;/Volume_Example/grid_PE_6runs_minimum_density.h5&#39;</span>
        <span class="n">dp</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">min_coords</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">create_density_map</span><span class="p">(</span><span class="n">gridfile</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="n">maptype</span><span class="p">,</span> <span class="n">den_threshold</span><span class="o">=</span><span class="n">cut_off_threshold</span><span class="p">,</span> <span class="n">den_scale</span><span class="o">=</span><span class="n">density_scale_factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLVolumeItem</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># scale with resolution (because the voxels default to resolution (1,1,1))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">min_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">min_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># translate to minimum of grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_plot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.add_zbrainatlas"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_zbrainatlas">[docs]</a>    <span class="k">def</span> <span class="nf">add_zbrainatlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load full ZBrainAtlas regions.</span>
<span class="sd">        Parameter:</span>
<span class="sd">        -----------</span>
<span class="sd">            filepath: str</span>
<span class="sd">                filepath where the ZBrainAtlas outlines are located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span> <span class="c1"># because it is added to self.rec</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">load_zbrain_regions</span><span class="p">(</span><span class="n">recording</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="p">,</span> <span class="n">zbrainfile</span><span class="o">=</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_region_view_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># enable menu function to toggle between views</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Please load the main data before loading the ZBrainAtlas.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.change_region_view"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.change_region_view">[docs]</a>    <span class="k">def</span> <span class="nf">change_region_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Toggle function to change region view between local labels and ZBrainAtlas labels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;zbrainatlas_coordinates&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>  <span class="c1"># if zbrainatlas is not yet loaded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_zbrainatlas</span><span class="p">()</span>  <span class="c1"># load using default path (in ~/fishualizer/data/ZBrainAtlas folder)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span>  <span class="c1"># toggle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_check_cb</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_change</span><span class="p">()</span>  <span class="c1"># update</span></div>

<div class="viewcode-block" id="Fishualizer.draw_xy_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_xy_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_xy_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw outline of xy plane (by calling draw_outline())&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_outline_action</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span> <span class="c1"># if selected to True; draw new outline</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
                <span class="n">len_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># match long and short dimensions</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># if deselected (to False); remove current outline</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># the outline is indexed by dim_other, remove previous outline</span></div>

<div class="viewcode-block" id="Fishualizer.draw_xz_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_xz_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_xz_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw outline of xz plane (by calling draw_outline())&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xz_outline_action</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
                <span class="n">len_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># the outline is indexed by dim_other, remove previous outline</span></div>

<div class="viewcode-block" id="Fishualizer.draw_yz_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_yz_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_yz_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw outline of yz plane (by calling draw_outline())&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yz_outline_action</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>
                <span class="n">len_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">len_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_outline</span><span class="p">(</span><span class="n">dim_short</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># the outline is indexed by dim_other, remove previous outline</span></div>

<div class="viewcode-block" id="Fishualizer.draw_outline"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.draw_outline">[docs]</a>    <span class="k">def</span> <span class="nf">draw_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_short</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_long</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">moving_average</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">select_method</span><span class="o">=</span><span class="s1">&#39;minmax&#39;</span><span class="p">,</span> <span class="n">param_alpha</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw outline of the fish. Use current coordinates or zbrainatlas_coordinates,</span>
<span class="sd">        depending on self._use_zbrainatlas_coords</span>
<span class="sd">        The outline is drawn for the two dimensional plane (dim_short, dim_long),</span>
<span class="sd">        and is saved by the complementary dimension index (dim_other) in self.outline_plot[dim_other].</span>

<span class="sd">        Two methods can be used to create the outlines; minmax or alpha_shapeself.</span>
<span class="sd">        minmax is faster, but less accurate. The default (by menu access) is currently</span>
<span class="sd">        set to &#39;minmax&#39; for speed reasons, the &#39;alpha_shape&#39; (for better figures)</span>
<span class="sd">        can be accessed from the console.</span>
<span class="sd">        Alternatively, one could also skip every n coordinates to speed up the process,</span>
<span class="sd">        but this is currently not implemented because the alpha_shaping will not be</span>
<span class="sd">        instantaneous anyway. This might however be nice for less powerful computers. (# TODO)</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            dim_short: int (0, 1, 2)</span>
<span class="sd">                short dimension of outline</span>
<span class="sd">            dim_long: int (0, 1, 2).remove(dim_short)</span>
<span class="sd">                long dimension of outline (this split up is better for min/max outlining)</span>
<span class="sd">            line_width: float/int?</span>
<span class="sd">                width of line to draw</span>
<span class="sd">            moving_average: bool</span>
<span class="sd">                whether to compute the moving average (per 3 points) of the line (for smoothing)</span>
<span class="sd">            select_method: str (&#39;minmax&#39;, &#39;alpha_shape&#39;)</span>
<span class="sd">                which method to use for selecting the points that make the outline of the fish</span>
<span class="sd">            param_alpha: float</span>
<span class="sd">                alpha value to use in case select_method == &#39;alpha_shape&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_zbrainatlas_coords</span><span class="p">:</span>  <span class="c1"># use full zbrainatlas</span>
            <span class="n">neurons_draw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">iloop</span><span class="p">,</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_zbrain_divisions</span><span class="p">):</span>  <span class="c1"># use outlines from main divisions</span>
                <span class="n">tmp_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">zbrainatlas_regions</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">neurons_draw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">neurons_draw</span><span class="p">,</span> <span class="n">tmp_sel</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># add to neurons_draw</span>
            <span class="n">neurons_draw</span> <span class="o">=</span> <span class="n">neurons_draw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">zbrainatlas_coordinates</span><span class="p">[</span><span class="n">neurons_draw</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># get coordinates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span>  <span class="c1"># get coordinates of current coordinate selection</span>

        <span class="n">all_dims</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">all_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dim_short</span><span class="p">)</span>
        <span class="n">all_dims</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dim_long</span><span class="p">)</span>
        <span class="n">dim_other</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_dims</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># the dim that is not dim_short or dim_long</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="n">dim_other</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="n">dim_other</span><span class="p">])</span>  <span class="c1"># the outline is indexed by dim_other, remove previous outline</span>

        <span class="k">if</span> <span class="n">select_method</span> <span class="o">==</span> <span class="s1">&#39;minmax&#39;</span><span class="p">:</span>
            <span class="n">dlong_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_long</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_long</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># array to create outlines with</span>
            <span class="n">shortmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dlong_arr</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># assuming -1 is not possible</span>
            <span class="n">shortmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dlong_arr</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">prev_dlong</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">iloop</span><span class="p">,</span> <span class="n">dlong</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dlong_arr</span><span class="p">):</span>  <span class="c1"># loop through array of long dimension values</span>
                <span class="n">current_sel</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_long</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlong</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_long</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev_dlong</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_sel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">shortmin</span><span class="p">[</span><span class="n">iloop</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">current_sel</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># set to min</span>
                    <span class="n">shortmin</span><span class="p">[</span><span class="n">iloop</span><span class="p">,</span> <span class="n">dim_long</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlong</span>  <span class="c1"># set to current element of long dimension value array</span>
                    <span class="n">shortmax</span><span class="p">[</span><span class="n">iloop</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">current_sel</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">shortmax</span><span class="p">[</span><span class="n">iloop</span><span class="p">,</span> <span class="n">dim_long</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlong</span>
                    <span class="n">prev_dlong</span> <span class="o">=</span> <span class="n">dlong</span>
            <span class="n">shortmin</span><span class="p">[:,</span> <span class="n">dim_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shortmin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># set non-considered dim to 0 (is translated later)</span>
            <span class="n">shortmax</span><span class="p">[:,</span> <span class="n">dim_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shortmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">shortmin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># loop to remove all non-assigned points of outline</span>
                <span class="k">if</span> <span class="n">shortmin</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">shortmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shortmin</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">shortmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shortmax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">moving_average</span><span class="p">:</span>  <span class="c1"># compute moving average per 3 points to smooth</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shortmin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">shortmin</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">shortmin</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">+</span> <span class="n">shortmin</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">+</span> <span class="n">shortmin</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shortmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">shortmax</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">shortmax</span><span class="p">[</span><span class="n">jj</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">+</span> <span class="n">shortmax</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">]</span> <span class="o">+</span> <span class="n">shortmax</span><span class="p">[</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim_short</span><span class="p">])</span>
            <span class="n">line_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">shortmin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">shortmax</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># importantly, line_points need to be sequentially sorted (hence the np.flip)</span>

        <span class="k">elif</span> <span class="n">select_method</span> <span class="o">==</span> <span class="s1">&#39;alpha_shape&#39;</span><span class="p">:</span>
            <span class="n">dim_used</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">({</span><span class="n">dim_short</span><span class="p">,</span> <span class="n">dim_long</span><span class="p">}))</span>  <span class="c1"># sorted(!) np array of used dimensions</span>
            <span class="n">outline_test</span> <span class="o">=</span> <span class="n">alpha_shape</span><span class="o">.</span><span class="n">alpha_fish_new</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_used</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">param_alpha</span><span class="p">)</span>  <span class="c1"># get 2D alpha shape from alpha_shape.py file</span>
            <span class="n">outline_points</span> <span class="o">=</span> <span class="n">outline_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># outline points</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">outline_test</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># unpack outline points</span>
                <span class="k">if</span> <span class="n">kk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outline_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">outline_points</span><span class="p">,</span> <span class="n">vv</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">center_test</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[:,</span> <span class="n">dim_used</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># center of fish in 2D plane</span>
            <span class="n">ph_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">center_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">outline_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span><span class="p">(</span> <span class="n">center_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">outline_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>  <span class="c1"># determine phase of every point w.r.t. center in 2D plane</span>
            <span class="n">ph_test</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outline_points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">center_test</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># add pi to left half of points (because arctan maps everything to half the phase interval)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ph_test</span><span class="p">)</span>  <span class="c1"># argsort the phases</span>
            <span class="n">tmp_line_points</span> <span class="o">=</span> <span class="n">outline_points</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># order all outline points (because a line is draw sequentially)</span>
            <span class="c1"># Note: sorting by phase works quite well, but is not guaranteed to be perfect..</span>
            <span class="k">if</span> <span class="n">dim_other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># three cases to add back third dimension</span>
                <span class="n">line_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tmp_line_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">tmp_line_points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dim_other</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">line_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tmp_line_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tmp_line_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">line_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">line_points</span><span class="p">,</span> <span class="n">tmp_line_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dim_other</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">line_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tmp_line_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tmp_line_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">moving_average</span><span class="p">:</span>  <span class="c1"># compute moving average per 3 points to smooth</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">line_points</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">line_points</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">line_points</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">line_points</span><span class="p">[</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># line_colors = np.zeros((len(line_points), 4)) + 255  # use for dotted line</span>
        <span class="c1"># line_colors[::2, 3] = 1   # make even points visible</span>
        <span class="c1"># line_colors[1::2, 3] = 0  # make uenven points invisible (together they create a dotted line 1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="n">dim_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">line_points</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span><span class="c1">#, color=line_colors,  antialias=False, mode=&#39;lines&#39;)  # create GLLinePlotItem to plot outline</span>
        <span class="n">meancoords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">translate_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">translate_xyz</span><span class="p">[</span><span class="n">dim_other</span><span class="p">]</span> <span class="o">=</span> <span class="n">meancoords</span><span class="p">[</span><span class="n">dim_other</span><span class="p">]</span>  <span class="c1"># translate to mean of current coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="n">dim_other</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translate_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">translate_xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">translate_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline_plot</span><span class="p">[</span><span class="n">dim_other</span><span class="p">])</span></div>

<div class="viewcode-block" id="Fishualizer.reset_view"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.reset_view">[docs]</a>    <span class="k">def</span> <span class="nf">reset_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">sel_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>
<div class="viewcode-block" id="Fishualizer.add_scale_bar"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.add_scale_bar">[docs]</a>    <span class="k">def</span> <span class="nf">add_scale_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bar_width</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a scale bar to the plot.</span>

<span class="sd">        Scale bar is stored in self.scale_bar and added to self.view3D. This function</span>
<span class="sd">        overwrites previous scale bar if it exists.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            start: list of 3 floats</span>
<span class="sd">                start coordinates [x, y, z] of scale bar</span>
<span class="sd">            end: list of 3 floats</span>
<span class="sd">                end coordinates [x, y, z] of scale bar</span>
<span class="sd">            bar_width: float/int</span>
<span class="sd">                width of scale bar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_bar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_bar</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_bar</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">GLLinePlotItem</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_bar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Scale bar added. Size x </span><span class="si">{size[0]}</span><span class="s1">, y </span><span class="si">{size[1]}</span><span class="s1">, z </span><span class="si">{size[2]}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fishualizer.remove_all_other_items"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.Fishualizer.remove_all_other_items">[docs]</a>    <span class="k">def</span> <span class="nf">remove_all_other_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove all items other than data, scale bar, outline or region hulls for</span>
<span class="sd">        figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_x_axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_y_axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_z_axis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_3D</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Grids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view3D</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="n">g</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="handle_exception"><a class="viewcode-back" href="../Fishualizer.html#Fishualizer.handle_exception">[docs]</a><span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle uncaught exceptions and print in logger.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Fishlog&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">__excepthook__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Uncaught exception&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Testing the application</span>
    <span class="n">qApp</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="c1"># Create a GUI instance</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">Fishualizer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
    <span class="c1"># Wait for it to be finished</span>
    <span class="c1"># sys.exit(qApp.exec_())</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">ipkernel</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Rémi Proville, Thijs van der Plas, Bernhard Englitz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>